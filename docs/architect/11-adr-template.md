# Chapter 11：架構決策紀錄模板

> **本章定位**：決策文件化。學會記錄「為什麼這樣做」，而不只是「做了什麼」。
>
> 「六個月後你會忘記自己為什麼做了這個決定。但 ADR 不會忘。」

---

## 什麼是 ADR？

### ADR = Architecture Decision Record

```
問題：你有沒有過這種經驗？

  看著三個月前自己寫的程式碼，心想：
  「當時為什麼要這樣做？一定有什麼原因吧...」
  然後想了半天想不起來。

  或是更慘的版本：
  新人加入團隊，問：「為什麼用 PostgreSQL 而不是 MongoDB？」
  全場沉默。因為做這個決定的人已經離職了。

ADR 就是解決這個問題的工具：
  把每一個重要的架構決策記錄下來，
  包括背景、選項、權衡、決定、以及後果。
```

### 類比：ADR 就像法官的判決書

```
法官不是只說「有罪」或「無罪」。
判決書會寫：
  - 案件背景（Context）
  - 雙方的論點（Options）
  - 法律依據和權衡（Trade-offs）
  - 最終裁決（Decision）
  - 判決的影響（Consequences）

ADR 也一樣：
  不是只記錄「我們選了 X」，
  而是記錄「我們為什麼選了 X，以及選了 X 之後會怎樣」。
```

---

## ADR 標準模板

### 模板

```markdown
# ADR-{編號}：{決策標題}

## 狀態
{proposed | accepted | deprecated | superseded by ADR-XXX}

## 日期
{YYYY-MM-DD}

## 決策者
{誰參與了這個決策}

## 背景（Context）
{什麼情況下需要做這個決定？
 - 目前的問題或需求是什麼？
 - 有什麼限制條件？
 - 有什麼相關的技術背景？}

## 選項（Options）

### 選項 A：{名稱}
- 說明：{這個選項是什麼}
- 優點：{好處}
- 缺點：{壞處}
- 成本：{實施成本}
- 風險：{潛在風險}

### 選項 B：{名稱}
- 說明：
- 優點：
- 缺點：
- 成本：
- 風險：

### 選項 C：{名稱}（如有）
...

## 權衡分析（Trade-offs）

| 評估維度 | 選項 A | 選項 B | 選項 C |
|----------|--------|--------|--------|
| {維度1}  |        |        |        |
| {維度2}  |        |        |        |
| {維度3}  |        |        |        |

## 決策（Decision）
{我們選擇了什麼？為什麼？}

## 後果（Consequences）

### 正面後果
- {選了這個方案帶來的好處}

### 負面後果
- {選了這個方案要承受的代價}

### 衍生的後續決策
- {因為這個決定，接下來還需要做什麼決定？}

## 驗證方式
{怎麼知道這個決定是對的？}

## 修訂紀錄
| 日期 | 變更 | 原因 |
|------|------|------|
| | | |
```

---

## ADR 實例

### ADR-001：RAG 向量資料庫選擇

```markdown
# ADR-001：RAG 向量資料庫選擇

## 狀態
accepted

## 日期
2025-12-01

## 決策者
技術架構組（Aaron, Mei, Leo）

## 背景（Context）
我們的 AI 分析系統需要一個向量資料庫來支撐 RAG 功能。
需求如下：
- 預估文件量：500 份（約 50,000 chunks）
- 查詢延遲要求：< 500ms
- 團隊已有 PostgreSQL 經驗
- 預算有限，優先考慮低成本方案
- 未來一年可能需要擴展到 5,000 份文件

## 選項

### 選項 A：Supabase pgvector
- 說明：在現有 PostgreSQL 上啟用 pgvector 擴展
- 優點：
  - 不需要額外學新技術
  - 與現有資料庫整合，減少維運複雜度
  - Supabase 免費方案可用
  - SQL 查詢可結合向量搜尋和 metadata 過濾
- 缺點：
  - 大規模時效能不如專用向量 DB
  - 向量索引功能較基本
- 成本：$0/月（免費方案）→ $25/月（Pro）
- 風險：5,000+ 文件時可能需要遷移

### 選項 B：Pinecone
- 說明：雲端專用向量資料庫
- 優點：
  - 專為向量搜尋設計，效能優異
  - 自動擴展
  - 管理簡單
- 缺點：
  - 額外的服務依賴
  - 團隊需要學習新技術
  - 資料在外部（可能有合規疑慮）
- 成本：$70/月起
- 風險：供應商鎖定（Vendor lock-in）

### 選項 C：ChromaDB（本地部署）
- 說明：開源向量資料庫，本地部署
- 優點：
  - 完全免費
  - 資料在本地
  - Python 原生支援
- 缺點：
  - 需要自己維運
  - 沒有雲端備份
  - 大規模時擴展困難
- 成本：$0（但有維運人力成本）
- 風險：單點故障、資料遺失

## 權衡分析

| 評估維度 | pgvector | Pinecone | ChromaDB |
|----------|----------|----------|----------|
| 學習成本 | 低（已會 SQL）| 中 | 低 |
| 月費用 | $0-25 | $70+ | $0 |
| 效能（50K chunks）| 夠用 | 優異 | 夠用 |
| 擴展性 | 中 | 高 | 低 |
| 維運複雜度 | 低 | 低 | 中 |
| 資料安全 | 高 | 中 | 高 |
| 整合複雜度 | 低 | 中 | 低 |

## 決策
**選擇 Supabase pgvector**

原因：
1. 團隊已有 PostgreSQL 經驗，學習成本最低
2. 可與現有業務資料庫整合，減少系統複雜度
3. 免費方案足以支撐初期需求（50K chunks）
4. SQL + 向量搜尋的組合對我們的 use case 最合適

## 後果

### 正面後果
- 團隊可以立即開始開發（無需學新技術）
- 系統架構更簡潔（一個 DB 解決結構化+向量化需求）
- 成本可控

### 負面後果
- 如果文件量超過 500K chunks，可能需要遷移到專用向量 DB
- pgvector 的進階功能（如 HNSW 參數調優）文件較少

### 衍生的後續決策
- ADR-002：Chunk 策略設計（需考慮 pgvector 的特性）
- 需要在 200K chunks 時重新評估效能

## 驗證方式
- 用 50K chunks 做壓力測試，確認延遲 < 500ms
- 每季評估一次向量 DB 效能和成本

## 修訂紀錄
| 日期 | 變更 | 原因 |
|------|------|------|
| 2025-12-01 | 初版 | 專案啟動 |
```

---

## 什麼時候需要寫 ADR？

### 需要寫 ADR 的決策

```
判斷標準：這個決策的影響半徑大嗎？

✅ 需要寫 ADR：
  - 技術選型（框架、資料庫、語言）
  - 架構模式（微服務 vs 單體）
  - 資料模型設計
  - 安全和認證策略
  - 第三方服務選擇
  - API 設計風格
  - 部署策略

❌ 不需要寫 ADR：
  - 變數命名
  - 程式碼格式
  - 個別函數的實作方式
  - 日常 bug 修復
  - 文字內容修改
```

### ADR 的生命週期

```
┌──────────┐     ┌──────────┐     ┌──────────────┐
│ Proposed │ ──→ │ Accepted │ ──→ │ Deprecated   │
│ 提出      │     │ 接受     │     │ 或           │
│          │     │         │     │ Superseded   │
└──────────┘     └──────────┘     │ (被新版取代) │
                                  └──────────────┘

Proposed：團隊討論中
Accepted：已決定並執行
Deprecated：不再適用（情況改變了）
Superseded：被新的 ADR 取代
```

---

## ADR 管理最佳實踐

### 編號規則

```
ADR-001：第一個決策
ADR-002：第二個決策
...
永遠遞增，不重複使用編號。
即使 ADR-003 被 deprecated，也不會有新的 ADR-003。
```

### 目錄組織

```
docs/
  adr/
    ADR-001-vector-db-selection.md
    ADR-002-chunk-strategy.md
    ADR-003-auth-method.md
    ADR-004-deployment-strategy.md
    INDEX.md        ← ADR 索引
```

### INDEX.md 範例

```markdown
# 架構決策紀錄索引

| 編號 | 標題 | 狀態 | 日期 |
|------|------|------|------|
| ADR-001 | RAG 向量資料庫選擇 | accepted | 2025-12-01 |
| ADR-002 | Chunk 策略設計 | accepted | 2025-12-05 |
| ADR-003 | 認證方式選擇 | deprecated | 2025-12-10 |
| ADR-004 | 部署策略 | proposed | 2025-12-15 |
```

### 寫好 ADR 的五個原則

```
原則 1：寫給六個月後的自己看
  → 假設讀者不知道任何背景

原則 2：記錄被拒絕的選項
  → 未來有人想用那個選項時，可以看到當時為什麼沒選

原則 3：誠實面對缺點
  → 每個決策都有代價，不要假裝沒有

原則 4：量化而非模糊
  → ❌ 「效能比較好」
  → ✅ 「50K chunks 下延遲 < 500ms」

原則 5：保持更新
  → 情況變了就更新狀態
  → 不要讓過時的 ADR 誤導未來的人
```

---

## 動手做：寫你的第一個 ADR

### 練習 11-1：回顧性 ADR

選一個你在過去的專案中做過的技術決策（例如：為什麼用 React 而不是 Vue？為什麼用 MySQL 而不是 MongoDB？）。

用本章的模板寫一份回顧性 ADR。即使是回顧，也要：
- 列出當時考慮過的選項
- 分析權衡
- 記錄後果（現在回頭看，這個決定對嗎？）

### 練習 11-2：為期末專案寫 ADR

為你的期末專案的 **一個重要技術決策** 寫一份 ADR。可能的主題：
- 向量資料庫選擇
- AI 模型選擇
- 前端框架選擇
- 部署方式選擇
- 認證機制選擇

### 練習 11-3：ADR Review

跟同學交換 ADR，扮演「質疑者」的角色：
1. 背景描述完整嗎？外人看得懂嗎？
2. 選項分析公平嗎？有沒有偏見？
3. 權衡分析有遺漏的維度嗎？
4. 決策理由站得住腳嗎？
5. 後果分析有漏掉的風險嗎？

---

## 本章重點回顧

```
┌─────────────────────────────────────────────┐
│          ADR 五大記憶點                        │
│                                               │
│  1. ADR 記錄「為什麼」而不只是「做了什麼」     │
│  2. 五要素：背景 → 選項 → 權衡 → 決策 → 後果  │
│  3. 只為重要的架構決策寫 ADR                   │
│  4. 被拒絕的選項也要記錄                       │
│  5. ADR 要持續更新，不要讓它過時               │
└─────────────────────────────────────────────┘
```

---

## 下一章預告

恭喜你走到這裡。最後一章。

在 [Chapter 12：架構師導向評分標準](12-final-rubric.md) 中，你會看到：
- 你的專案會怎麼被評分
- 每個維度的評分細則
- 從 A+ 到 C 的差異在哪裡

這是你的「終點線」和「起跑線」。
