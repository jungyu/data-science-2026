# Ch06 — 工具與超能力：MCP 與 Tool Use

> **「一個人的能力有限，但能使用工具的人，能力無限。」**

---

## 🎯 本章學習目標

讀完這章，你將能夠：

- [ ] 解釋 Tool Use 的運作機制
- [ ] 理解 MCP（Model Context Protocol）的架構
- [ ] 說出四大 MCP 伺服器的用途
- [ ] 判斷何時該啟用哪個 MCP 伺服器

---

## 工具：讓 Agent 從思考者變成行動者

### 沒有工具的 Agent

```
你：「專案裡有多少個 TODO？」
Agent：「根據我的經驗，一般專案大概會有 10-20 個 TODO...」
       （這是猜測，不是事實）
```

### 有工具的 Agent

```
你：「專案裡有多少個 TODO？」
Agent：[使用 Grep 搜尋 "TODO"]
       「我在 23 個檔案中找到了 47 個 TODO。
        按優先順序分類：
        - 🔴 緊急(P0)：3 個
        - 🟡 重要(P1)：12 個
        - 🟢 日後(P2)：32 個」
       （這是事實，基於實際搜尋）
```

---

## Tool Use 的運作機制

### 一次工具呼叫的完整流程

```
┌──────────┐         ┌──────────┐         ┌──────────┐
│  使用者    │         │  Agent   │         │  系統     │
│          │         │  (LLM)   │         │  (工具)   │
└────┬─────┘         └────┬─────┘         └────┬─────┘
     │                    │                     │
     │ 「讀取 app.js」     │                     │
     │──────────────────→│                     │
     │                    │                     │
     │                    │ 決定使用 Read 工具   │
     │                    │  {file: "app.js"}   │
     │                    │────────────────────→│
     │                    │                     │
     │                    │   檔案內容           │
     │                    │←────────────────────│
     │                    │                     │
     │                    │ 分析內容，生成回應    │
     │                    │                     │
     │ 「app.js 是一個...」│                     │
     │←──────────────────│                     │
     │                    │                     │
```

### 多工具協調

複雜任務通常需要多個工具協作：

```
任務：「修復 auth.js 中的 Bug」

Step 1: Grep("error.*auth")     → 找到錯誤相關程式碼
Step 2: Read("src/auth.js")     → 讀取完整檔案
Step 3: Read("tests/auth.test") → 讀取現有測試
Step 4: Edit("src/auth.js")     → 修改問題程式碼
Step 5: Bash("npm test")        → 執行測試驗證
Step 6: Bash("git diff")        → 顯示變更摘要
```

> 💡 **關鍵洞察**：Agent 自主決定使用哪些工具、什麼順序。
> 你只需要描述目標，Agent 會規劃工具的使用策略。

---

## Agent 的內建工具箱

### 工具分類總覽

```
┌─────────────────────────────────────────────────┐
│                                                   │
│  📖 感知工具 — 理解環境                           │
│  ═══════════════════════                          │
│  Read     讀取檔案內容                             │
│  Glob     按模式搜尋檔案（找檔案名稱）              │
│  Grep     按內容搜尋檔案（找程式碼片段）            │
│                                                   │
│  ✏️ 行動工具 — 修改環境                           │
│  ═══════════════════════                          │
│  Edit     修改現有檔案的特定部分                    │
│  Write    建立新檔案或完整覆寫                     │
│                                                   │
│  🖥️ 執行工具 — 與系統互動                         │
│  ═══════════════════════                          │
│  Bash     執行 Shell 命令                          │
│                                                   │
│  🌐 資訊工具 — 獲取外部資訊                       │
│  ═══════════════════════                          │
│  WebSearch   搜尋網路                              │
│  WebFetch    抓取網頁內容                          │
│                                                   │
│  📋 管理工具 — 組織工作                            │
│  ═══════════════════════                          │
│  TodoWrite   管理任務清單                          │
│  Task        委派子任務給其他 Agent                 │
│                                                   │
└─────────────────────────────────────────────────┘
```

### 何時用什麼工具？

| 你想做的事 | 用什麼工具 | 範例 |
|-----------|-----------|------|
| 找某個檔案 | Glob | `Glob("**/*.config.ts")` |
| 找某段程式碼 | Grep | `Grep("TODO", type="ts")` |
| 看某個檔案的內容 | Read | `Read("/src/app.js")` |
| 改檔案的一部分 | Edit | `Edit(file, old, new)` |
| 建新檔案 | Write | `Write("/src/new.ts", content)` |
| 跑測試 | Bash | `Bash("npm test")` |
| 裝套件 | Bash | `Bash("npm install express")` |
| 查 Git 狀態 | Bash | `Bash("git status")` |
| 搜尋技術資訊 | WebSearch | `WebSearch("React 19 new features")` |

---

## MCP：Agent 的超能力系統

### 什麼是 MCP？

**MCP（Model Context Protocol）** 是一個讓 Agent 連接外部服務的標準協議。

如果內建工具是 Agent 的「基本技能」，那 MCP 伺服器就是「專業裝備」。

```
沒有 MCP 的 Agent：
┌─────────┐
│  Agent   │ ← 只有基本工具
│  🔧🔍📖  │
└─────────┘

有 MCP 的 Agent：
┌─────────┐
│  Agent   │ ← 基本工具 + 專業裝備
│  🔧🔍📖  │
└────┬────┘
     │
     ├──→ 📚 Context7（查文件）
     ├──→ 🧠 Sequential（深度分析）
     ├──→ 🎨 Magic（生成 UI）
     └──→ 🎭 Playwright（瀏覽器測試）
```

### MCP 的運作原理

```
┌─────────────────────────────────────────────────┐
│                 MCP 架構                          │
│                                                   │
│  ┌──────────┐        ┌────────────────┐          │
│  │  Agent    │        │  MCP 伺服器     │          │
│  │  (Client) │◄──────►│  (Server)      │          │
│  └──────────┘  MCP   └───────┬────────┘          │
│                Protocol       │                   │
│                         ┌─────┴─────┐             │
│                         │ 外部資源   │             │
│                         │           │             │
│                         │ - API     │             │
│                         │ - 資料庫   │             │
│                         │ - 瀏覽器   │             │
│                         │ - 文件庫   │             │
│                         └───────────┘             │
└─────────────────────────────────────────────────┘
```

Agent 透過 MCP 協議和伺服器溝通，就像瀏覽器透過 HTTP 和網站溝通一樣。

---

## 四大 MCP 伺服器

### 1. Context7 📚 — 文件專家

**用途**：查詢函式庫的官方文件、最佳實踐、程式碼範例

```
場景：你要用 Prisma 寫一個複雜查詢

沒有 Context7：
Agent 可能用過時的語法，或者「編造」一個不存在的 API

有 Context7：
Agent 查詢 Prisma 最新文件 → 使用正確的語法 → 附上官方範例
```

**自動啟用時機**：
- 偵測到外部函式庫的 import 語句
- 與框架相關的問題
- 使用 `--c7` 標誌手動啟用

**工作流程**：
```
1. 偵測到你用了 Prisma
2. resolve-library-id → 找到 "prisma" 的 Context7 ID
3. get-library-docs → 取得相關文件
4. 使用文件中的模式來生成程式碼
```

### 2. Sequential 🧠 — 深度思考器

**用途**：複雜的多步驟分析、架構設計、系統性除錯

```
場景：你的 API 突然變慢，需要找出原因

Sequential 的分析過程：
Step 1: 分解問題 — 可能的原因有哪些？
Step 2: 收集證據 — 日誌、效能指標、最近的變更
Step 3: 建立假設 — 最可能是 N+1 查詢問題
Step 4: 驗證假設 — 分析查詢日誌
Step 5: 提出解決方案 — 使用 eager loading
Step 6: 評估風險 — 記憶體使用可能增加
```

**自動啟用時機**：
- 複雜的除錯場景
- 系統設計問題
- 使用 `--think`、`--think-hard`、`--ultrathink` 標誌
- 使用 `--seq` 標誌手動啟用

**思考深度對照**：

| 標誌 | Token 預算 | 適用場景 |
|------|-----------|---------|
| `--think` | ~4K | 模組級分析 |
| `--think-hard` | ~10K | 系統級分析 |
| `--ultrathink` | ~32K | 關鍵系統重設計 |

### 3. Magic 🎨 — UI 元件工廠

**用途**：生成現代化的 UI 元件、設計系統整合、響應式設計

```
場景：你需要一個資料表格元件

Magic 的產出：
- React/Vue/Angular 元件
- 響應式設計（手機/平板/桌面）
- 無障礙支援（WCAG 2.1 AA）
- 暗色模式支援
- 動畫效果
```

**支援的元件類型**：
- 互動元件：按鈕、表單、對話框、下拉選單
- 版面元件：網格、卡片、側邊欄
- 資料展示：表格、圖表、清單
- 回饋元件：通知、進度條、載入動畫

**自動啟用時機**：
- UI 元件建立請求
- 設計系統相關工作
- 使用 `--magic` 標誌手動啟用

### 4. Playwright 🎭 — 瀏覽器自動化

**用途**：端對端測試、效能監控、跨瀏覽器驗證、視覺測試

```
場景：你需要測試登入流程

Playwright 的能力：
1. 打開 Chrome → 導航到登入頁
2. 填寫表單 → 點擊登入
3. 截圖 → 比對預期畫面
4. 測量效能指標 → 報告載入時間
5. 同時在 Chrome/Firefox/Safari 執行
```

**自動啟用時機**：
- 測試工作流程
- 效能監控需求
- 使用 `--play` 標誌手動啟用

---

## MCP 伺服器選擇指南

### 決策流程圖

```
你的任務是什麼？
    │
    ├── 需要查函式庫文件？ ──→ Context7 📚
    │
    ├── 需要深度分析/除錯？ ──→ Sequential 🧠
    │
    ├── 需要建立 UI 元件？ ──→ Magic 🎨
    │
    ├── 需要瀏覽器測試？ ──→ Playwright 🎭
    │
    ├── 以上都需要？ ──→ --all-mcp（全部啟用）
    │
    └── 以上都不需要？ ──→ 使用內建工具即可
```

### 組合使用場景

| 任務 | 推薦組合 | 原因 |
|------|---------|------|
| 新增 API 端點 | Context7 + Sequential | 查文件 + 規劃架構 |
| 建立頁面元件 | Magic + Playwright | 生成 UI + E2E 測試 |
| 效能最佳化 | Sequential + Playwright | 分析瓶頸 + 測量指標 |
| 安全審計 | Sequential + Context7 | 深度分析 + 最佳實踐 |
| 全端功能開發 | 全部 | 完整支援 |

---

## MCP 標誌速查

```
┌──────────────────────────────────────────────────┐
│              MCP 標誌速查                          │
│                                                    │
│  啟用：                                            │
│  --c7, --context7    啟用 Context7                 │
│  --seq, --sequential 啟用 Sequential               │
│  --magic             啟用 Magic                    │
│  --play, --playwright 啟用 Playwright              │
│  --all-mcp           啟用全部                      │
│                                                    │
│  停用：                                            │
│  --no-mcp            停用全部 MCP                  │
│  --no-magic          停用特定伺服器                 │
│  --no-seq            停用特定伺服器                 │
│                                                    │
│  思考深度：                                        │
│  --think             模組級 (~4K tokens)           │
│  --think-hard        系統級 (~10K tokens)          │
│  --ultrathink        關鍵級 (~32K tokens)          │
│                                                    │
└──────────────────────────────────────────────────┘
```

---

## 工具使用的最佳實踐

### 1. 讓 Agent 自己選工具

```
❌ 「用 Grep 搜尋所有 TODO，然後用 Read 讀取每個檔案...」
    → 你在替 Agent 決定工具使用策略

✅ 「找出專案中所有的 TODO 並按優先順序分類。」
    → Agent 自己決定最佳的工具組合
```

### 2. 需要時才啟用 MCP

```
❌ 每次都用 --all-mcp
   → 浪費 Token，增加延遲

✅ 根據任務類型選擇性啟用
   → 效率更高，成本更低
```

### 3. 善用平行處理

Agent 可以同時使用多個工具：

```
平行搜尋：
  Grep("TODO")     ──→ 結果 A
  Grep("FIXME")    ──→ 結果 B    → 合併分析
  Grep("HACK")     ──→ 結果 C
```

### 4. 理解工具的限制

| 工具 | 限制 | 解決方案 |
|------|------|---------|
| Read | 大檔案可能截斷 | 使用 offset + limit 分段讀取 |
| Bash | 命令有超時限制 | 長時間操作使用背景執行 |
| WebFetch | 無法存取需認證的頁面 | 使用專用 MCP 伺服器 |
| Edit | 必須先 Read 才能 Edit | 養成先讀後改的習慣 |

---

## 章末練習

### 🧪 動手做

1. **工具觀察**：給 Agent 一個中等複雜度的任務，觀察它使用了哪些工具、什麼順序。
   記錄下來並分析為什麼選擇這些工具。

2. **MCP 實驗**：嘗試用 `--c7` 讓 Agent 查詢你專案中使用的某個函式庫的文件。
   比較有無 Context7 時，Agent 的回答品質差異。

3. **工具限制**：故意給 Agent 一個會觸碰工具限制的任務
   （例如讀取一個非常大的檔案），觀察 Agent 如何處理。

### 🤔 思考題

1. 為什麼 Agent 不能直接執行任意系統命令，而要透過工具系統？
2. MCP 和傳統的 API 呼叫有什麼不同？
3. 什麼情況下你會選擇 `--no-mcp`？

---

## 關鍵概念回顧

| 概念 | 一句話總結 |
|------|-----------|
| Tool Use | Agent 透過工具與環境互動的機制 |
| MCP | 讓 Agent 連接外部服務的標準協議 |
| Context7 | 查詢函式庫的官方文件和最佳實踐 |
| Sequential | 多步驟深度分析和結構化推理 |
| Magic | 現代化 UI 元件生成 |
| Playwright | 瀏覽器自動化和 E2E 測試 |

---

> **下一章預告**：[Ch07 — 治理憲法：給 Agent 一部基本法](ch07-governance-constitution.md)
>
> 工具越強大，越需要規範。下一章我們將進入本手冊的核心主題 ——
> 如何為 Agent 建立一套「憲法」，確保它的力量被正確運用。
