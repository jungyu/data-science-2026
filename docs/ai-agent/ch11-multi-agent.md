# Ch11 — 多 Agent 協作：從單兵到軍團

> **「一個人可以走得很快，一群人可以走得很遠。」**

---

## 🎯 本章學習目標

讀完這章，你將能夠：

- [ ] 解釋多 Agent 系統的運作模式
- [ ] 使用 Task 工具委派子任務
- [ ] 設計 Agent 間的協調策略
- [ ] 判斷何時使用多 Agent vs 單 Agent

---

## 為什麼需要多 Agent？

### 單 Agent 的瓶頸

```
任務：「對整個專案做安全審計」

單 Agent 的問題：
1. 上下文窗口有限 → 無法同時看完所有檔案
2. 時間很長 → 逐一分析 100 個檔案需要很久
3. 專注力分散 → 同時考慮安全、效能、品質會降低深度
4. Token 消耗大 → 一次對話可能超過預算
```

### 多 Agent 的優勢

```
同一個任務，多 Agent 的做法：

┌──────────┐
│ 指揮官    │  分析任務，分配工作
│ (主Agent) │
└────┬─────┘
     │
     ├──→ Agent A: 分析 src/api/ 的安全性
     ├──→ Agent B: 分析 src/auth/ 的安全性
     ├──→ Agent C: 分析 src/db/ 的安全性
     └──→ Agent D: 分析依賴的安全漏洞

結果：
- 平行執行，速度快 4 倍
- 每個 Agent 專注一個領域，深度更高
- 各自的上下文窗口不會溢出
```

---

## 多 Agent 協作模式

### 模式一：主從委派（Delegation）

最常見的模式。一個主 Agent 把任務分解，委派給子 Agent。

```
┌───────────────────────────────────────────────┐
│                                                 │
│  主 Agent（指揮官）                              │
│  ┌─────────────┐                                │
│  │ 1. 分析任務  │                                │
│  │ 2. 分解子任務 │                                │
│  │ 3. 委派執行  │                                │
│  │ 4. 彙整結果  │                                │
│  └──────┬──────┘                                │
│         │                                        │
│    ┌────┼────┬────┐                              │
│    ▼    ▼    ▼    ▼                              │
│  ┌───┐┌───┐┌───┐┌───┐                           │
│  │子A ││子B ││子C ││子D │  各自獨立完成子任務      │
│  └─┬─┘└─┬─┘└─┬─┘└─┬─┘                           │
│    │    │    │    │                               │
│    └────┴────┴────┘                              │
│         │                                        │
│         ▼                                        │
│    ┌──────────┐                                  │
│    │ 彙整報告  │                                  │
│    └──────────┘                                  │
│                                                  │
└───────────────────────────────────────────────┘
```

**在 Claude Code 中的實作**：

```
主 Agent 使用 Task 工具委派：

Task("分析 src/api/ 目錄的安全性，
      檢查 SQL injection、XSS、CSRF 風險。
      列出所有發現的問題和修復建議。")

Task("分析 src/auth/ 目錄的認證邏輯，
      檢查密碼處理、Token 管理、權限控制。")

Task("分析 package.json 的所有依賴，
      用 npm audit 檢查已知漏洞。")
```

### 模式二：專家小組（Specialist Panel）

每個 Agent 扮演不同的專家角色，從不同視角分析。

```
同一段程式碼，不同專家的觀點：

┌────────────┐   ┌────────────┐   ┌────────────┐
│ 🔒 安全專家 │   │ ⚡ 效能專家 │   │ 🏗️ 架構專家│
│            │   │            │   │            │
│「這裡有     │   │「這個查詢   │   │「這個模組   │
│ XSS 風險」  │   │ 是 O(n²)」 │   │ 耦合太緊」  │
└────────────┘   └────────────┘   └────────────┘
       │                │                │
       └────────────────┼────────────────┘
                        ▼
                 ┌────────────┐
                 │ 綜合報告    │
                 │            │
                 │ 安全：2 個  │
                 │ 效能：1 個  │
                 │ 架構：3 個  │
                 └────────────┘
```

### 模式三：流水線（Pipeline）

Agent 按順序處理，每個 Agent 在前一個的結果上繼續。

```
Agent A          Agent B          Agent C
分析程式碼    →   規劃修改     →   執行修改
                                     │
Agent F          Agent E          Agent D
更新文件     ←   整合測試     ←   撰寫測試
```

---

## 在 Claude Code 中使用多 Agent

### Task 工具

```
主 Agent 可以使用 Task 工具啟動子 Agent：

Task(
  prompt: "分析 src/api/ 的安全性",
  subagent_type: "Explore"  // 用探索型 Agent
)

Task(
  prompt: "撰寫 auth 模組的重構計畫",
  subagent_type: "Plan"     // 用規劃型 Agent
)
```

### /spawn 命令

用 `/spawn` 命令可以更有組織地啟動多 Agent：

```
/spawn --mode parallel --tasks [
  "分析安全性",
  "分析效能",
  "分析程式碼品質"
]
```

### 平行 vs 順序

```
平行（獨立的任務）：
Task A ──→ 結果 A ─┐
Task B ──→ 結果 B ─┼→ 彙整
Task C ──→ 結果 C ─┘

順序（有依賴的任務）：
Task A ──→ 結果 A ──→ Task B ──→ 結果 B ──→ Task C
```

**原則**：能平行就平行，有依賴才順序。

---

## 多 Agent 的挑戰

### 挑戰 1：上下文不共享

```
問題：
子 Agent 不知道主 Agent 的對話內容

解決：
在委派時提供足夠的上下文

❌ Task("修好那個 Bug")
   → 子 Agent 不知道「那個 Bug」是什麼

✅ Task("修復 src/auth.js:42 的空指標問題。
        目前 user.profile 在未登入時為 null，
        但 getProfile() 沒有檢查。
        請加入 null check 並回傳 401。")
```

### 挑戰 2：結果整合

```
問題：
多個子 Agent 的報告格式不一致

解決：
在委派時指定輸出格式

Task("分析安全性。請用以下格式回報：
      | 檔案 | 行號 | 風險等級 | 問題描述 | 建議修復 |")
```

### 挑戰 3：衝突修改

```
問題：
兩個 Agent 同時修改同一個檔案

解決：
- 使用 worktree 隔離（每個 Agent 在獨立的分支）
- 或確保任務分配時不會有檔案重疊
```

### 挑戰 4：成本控制

```
問題：
多 Agent 的 Token 消耗是單 Agent 的數倍

解決：
- 只在真正需要時使用多 Agent
- 控制子 Agent 的 max_turns
- 使用較小的模型處理簡單任務
```

---

## 何時使用多 Agent vs 單 Agent？

### 決策矩陣

```
┌──────────────────────────────────────────────────┐
│     使用單 Agent                                   │
│                                                    │
│  ✅ 任務涉及 < 5 個檔案                            │
│  ✅ 任務可以在一個上下文窗口內完成                  │
│  ✅ 步驟之間有強依賴（必須順序執行）                │
│  ✅ Token 預算有限                                  │
│                                                    │
├──────────────────────────────────────────────────┤
│     使用多 Agent                                   │
│                                                    │
│  ✅ 任務涉及 > 10 個檔案                           │
│  ✅ 可以平行處理的獨立子任務                        │
│  ✅ 需要多個專業視角                                │
│  ✅ 單一上下文窗口裝不下所有資訊                    │
│  ✅ 時間敏感，需要加速                              │
│                                                    │
└──────────────────────────────────────────────────┘
```

### 自動判斷規則

```
目錄數 > 7         → 自動建議使用多 Agent
檔案數 > 50        → 自動建議使用多 Agent
分析維度 > 2       → 自動建議使用專家小組
複雜度 > 0.8       → 自動建議使用多 Agent
```

---

## 實戰範例：多 Agent 程式碼審計

```
任務：「對整個專案做品質審計」

主 Agent 的策略：

1. 分析專案結構 → 識別出 5 個主要模組
2. 平行委派 5 個子 Agent：

   Agent-Security:
     "分析 src/ 中的安全漏洞，
      重點檢查 OWASP Top 10。"

   Agent-Performance:
     "分析 src/ 中的效能問題，
      重點檢查 N+1 查詢、記憶體洩漏。"

   Agent-Quality:
     "分析 src/ 中的程式碼品質，
      檢查複雜度、重複、命名規範。"

   Agent-Testing:
     "分析 tests/ 中的測試品質，
      檢查覆蓋率、有效性、維護性。"

   Agent-Architecture:
     "分析整體架構，
      檢查模組耦合、依賴方向、層級清晰度。"

3. 彙整 5 份報告 → 生成綜合品質報告
4. 按優先順序排列發現的問題
5. 生成修復計畫
```

---

## 章末練習

### 🧪 動手做

1. **委派練習**：用 Task 工具同時委派 3 個子 Agent，
   讓它們分別分析你專案的安全性、效能、程式碼品質。
   比較它們的發現是否有重疊。

2. **流水線設計**：設計一個 4 步驟的 Agent 流水線，
   完成「分析 → 規劃 → 實作 → 驗證」的完整流程。

3. **成本計算**：記錄一次多 Agent 操作的 Token 消耗，
   和單 Agent 執行相同任務的消耗比較。

### 🤔 思考題

1. 多 Agent 的結果品質一定比單 Agent 好嗎？什麼情況下不是？
2. 如果兩個子 Agent 對同一個問題給出矛盾的建議，主 Agent 應該怎麼做？
3. 多 Agent 系統需要什麼樣的「治理」？和單 Agent 治理有什麼不同？

---

## 關鍵概念回顧

| 概念 | 一句話總結 |
|------|-----------|
| 主從委派 | 主 Agent 分解任務，子 Agent 平行執行 |
| 專家小組 | 不同角色的 Agent 從不同視角分析 |
| 流水線 | Agent 按順序處理，每步建立在前步之上 |
| Task 工具 | Claude Code 中委派子 Agent 的機制 |
| 平行 vs 順序 | 能平行就平行，有依賴才順序 |

---

> **下一章預告**：[Ch12 — 走向生產：部署、監控與成本控制](ch12-production.md)
>
> 你已經掌握了單 Agent 和多 Agent 的使用方式。
> 下一章我們將討論如何在真實的生產環境中運用 Agent 系統。
