# Ch09 — 記憶與決策：Agent 如何記住與成長

> **「忘記歷史的人注定重蹈覆轍。」**

---

## 🎯 本章學習目標

讀完這章，你將能夠：

- [ ] 設計 Agent 的持久化記憶系統
- [ ] 使用 Decision Diary 記錄技術決策
- [ ] 理解決策的生命週期（建立 → 驗證 → 升級/廢棄）
- [ ] 建立決策可追溯的文化

---

## 為什麼記憶很重要？

### 沒有記憶的 Agent

```
第 1 天：
你：「我們應該用 Redis 還是 Memcached 做快取？」
Agent：（花了 20 分鐘分析）「建議用 Redis，因為...」
你：「好，用 Redis。」

第 15 天：
你：「幫我加一個快取機制。」
Agent：「我建議用 Memcached，因為...」  ← 忘了之前的決策
你：「...我們不是說好用 Redis 嗎？」
Agent：「抱歉，我不記得了。」

第 30 天：
新同事：「為什麼用 Redis 而不是 Memcached？」
所有人：「...好像沒人記得原因了。」
```

### 有記憶的 Agent

```
第 1 天：
你：「我們應該用 Redis 還是 Memcached？」
Agent：（分析後）「建議用 Redis。」
      →（自動記錄到 Decision Diary）

第 15 天：
你：「幫我加一個快取機制。」
Agent：「根據 diary 記錄（Day 1 決策），
       我們選擇了 Redis。原因是 [理由]。
       我會用 Redis 來實作。」  ← 記住了

第 30 天：
新同事：「為什麼用 Redis？」
Agent：「根據 diary（2024-01-15），
       我們選擇 Redis 是因為：
       1. 需要支援多種資料結構
       2. 需要持久化能力
       3. 未來可能用到 Pub/Sub
       當時也考慮了 Memcached，
       但它不支持持久化。」  ← 完整的決策脈絡
```

---

## Agent 記憶架構

```
┌──────────────────────────────────────────────────┐
│              Agent 記憶系統                        │
│                                                    │
│  ┌────────────────────────────────────────┐       │
│  │  📂 memory/ 目錄                        │       │
│  │                                        │       │
│  │  constitution.md  ← 不可變原則          │       │
│  │  diary.md         ← 決策日誌            │       │
│  │  patterns.md      ← 學到的模式          │       │
│  │  context.md       ← 專案脈絡            │       │
│  └────────────────────────────────────────┘       │
│                                                    │
│  ┌────────────────────────────────────────┐       │
│  │  📂 CLAUDE.md                           │       │
│  │                                        │       │
│  │  每次對話自動載入                        │       │
│  │  包含技術堆疊、規範、偏好               │       │
│  └────────────────────────────────────────┘       │
│                                                    │
│  ┌────────────────────────────────────────┐       │
│  │  📂 .claude/memory/ 目錄               │       │
│  │                                        │       │
│  │  自動記憶：Agent 觀察到的模式           │       │
│  │  跨對話保存                             │       │
│  └────────────────────────────────────────┘       │
│                                                    │
└──────────────────────────────────────────────────┘
```

---

## Decision Diary（決策日誌）

### 什麼是決策日誌？

Decision Diary 是一個**活的文件**，記錄專案中所有重要的技術決策。

它不同於 ADR（Architecture Decision Record）：

| 比較 | Decision Diary | ADR |
|------|---------------|-----|
| 格式 | 輕量、非正式 | 正式、結構化 |
| 門檻 | 低，任何決策都可記 | 高，只記架構級別 |
| 演化 | 可以修改、升級、廢棄 | 一旦決定較少修改 |
| 適合 | 日常開發決策 | 重大架構決策 |

### 日誌格式

```markdown
## [日期] [決策標題]

**Context**: 為什麼會面臨這個決策？

**Options**:
1. 方案 A — [描述] — 優：[優點] / 劣：[缺點]
2. 方案 B — [描述] — 優：[優點] / 劣：[缺點]

**Decision**: 選擇方案 [X]

**Rationale**: 為什麼選這個？

**Risks**: 已知的風險

**Validation**: 如何驗證這個決策是正確的？

**Status**: active | superseded | deprecated
```

### 實際範例

```markdown
## 2024-03-15 快取策略選擇

**Context**:
API 回應時間平均 800ms，需要加入快取層降低延遲。

**Options**:
1. Redis — 豐富的資料結構，支援持久化
   優：功能豐富、可靠 / 劣：需要額外運維
2. Memcached — 簡單快速
   優：極簡、快速 / 劣：不支援持久化、只有 K-V
3. 應用層記憶體 — Map/LRU Cache
   優：零運維 / 劣：重啟失效、不跨行程

**Decision**: 選擇 Redis

**Rationale**:
- 需要快取使用者 Session（需持久化）
- 未來計畫使用 Pub/Sub 做即時通知
- 團隊已有 Redis 運維經驗

**Risks**:
- Redis 連線中斷時的降級策略需要設計
- 記憶體使用量需要監控

**Validation**:
- 實施後 API 回應時間應降至 <200ms
- 30 天內觀察 Redis 穩定性

**Status**: active
```

---

## 決策的生命週期

```
┌──────────┐     ┌──────────┐     ┌──────────────┐
│ 🟡 建立   │ ──→ │ 🟢 驗證   │ ──→ │ ⬆️ 升級為原則  │
│ Create   │     │ Validate │     │  或           │
└──────────┘     └──────────┘     │ ⬇️ 廢棄       │
                                   └──────────────┘
```

### 建立（Create）

```
觸發條件：
- 面臨技術選擇時
- 討論出新的規範時
- 發現問題並決定解決方案時

動作：
- 寫入 diary.md
- 標記 Status: active
```

### 驗證（Validate）

```
觸發條件：
- 決策實施一段時間後（通常 2-4 週）
- 出現相關的 Bug 或問題時
- 團隊回顧時

動作：
- 評估決策的效果
- 記錄驗證結果
- 決定是否需要調整
```

### 升級或廢棄

```
升級為原則（→ constitution.md）：
- 決策經過驗證，效果良好
- 團隊共識這應該成為永久規則
- 有足夠的理由支持

廢棄（→ 標記 deprecated）：
- 決策已不適用（技術變遷、需求改變）
- 找到更好的替代方案
- 不刪除，標記為 deprecated 並說明原因
```

---

## 模式記憶（Patterns）

除了決策，Agent 還應該記住**有效的模式**。

### 什麼是模式記憶？

```markdown
# patterns.md

## 有效的模式

### API 錯誤處理模式
- 使用統一的 AppError class
- 在 middleware 集中處理
- 回傳格式：{ error: { code, message } }
- 首次發現：2024-01-10
- 驗證：已在 12 個端點使用，無問題

### 資料庫查詢最佳化模式
- 預設使用 select 限制欄位
- 列表查詢加分頁（limit + offset）
- 複雜查詢使用 Prisma 的 include 而非多次查詢
- 首次發現：2024-02-05
- 驗證：查詢時間平均降低 40%

## 失敗的模式（不要再用）

### ❌ 全域 try-catch
- 問題：吃掉所有錯誤，難以偵錯
- 改用：精準的 error boundary
- 教訓日期：2024-01-20
```

---

## 脈絡記憶（Context）

記錄專案的「為什麼」，而非只有「是什麼」。

```markdown
# context.md

## 專案背景
這是一個 B2B SaaS 平台，主要客戶是中小企業。
MVP 已上線 3 個月，目前有 50 個付費客戶。

## 技術選擇的脈絡
- 選擇 Next.js 是因為團隊最熟悉 React
- 選擇 PostgreSQL 是因為需要 JSON 查詢能力
- 選擇 Supabase 是因為需要即時訂閱功能

## 團隊狀況
- 3 位全端工程師
- 1 位兼職設計師
- 沒有專職 DevOps（自動化是最高優先）

## 已知的技術債
1. auth 模組太大（>800 行），需要拆分
2. 沒有 rate limiting，遲早要加
3. 測試覆蓋率只有 45%，目標 80%
```

---

## 讓 Agent 使用記憶

### 在 CLAUDE.md 中引用

```markdown
# CLAUDE.md

## 記憶系統
- 技術決策參考：memory/diary.md
- 有效模式參考：memory/patterns.md
- 專案脈絡參考：memory/context.md
- 不可妥協原則：memory/constitution.md

## 規則
- 做技術決策時，先查看 diary.md 是否有相關記錄
- 發現有效模式時，記錄到 patterns.md
- 重要脈絡變化時，更新 context.md
```

### Agent 如何使用

```
你：「幫我加一個快取機制。」

Agent 的思考過程：
1. 讀取 memory/diary.md
   → 找到「2024-03-15 快取策略選擇」
   → 已決定使用 Redis

2. 讀取 memory/patterns.md
   → 找到「API 錯誤處理模式」
   → 快取失敗時應遵循相同的錯誤處理模式

3. 讀取 memory/context.md
   → 了解「沒有專職 DevOps」
   → 快取配置應該盡量自動化

4. 基於以上記憶，生成實作方案
```

---

## 記憶維護最佳實踐

### 1. 定期清理

```
每月回顧一次 diary.md：
- 已過時的決策 → 標記 deprecated
- 已驗證的決策 → 考慮升級為原則
- 不再相關的 → 搬到歸檔區
```

### 2. 保持精簡

```
✅ 好的記憶：
「選擇 Redis 因為需要持久化和 Pub/Sub」
→ 一句話，關鍵資訊

❌ 壞的記憶：
（長達 3 頁的分析報告存在 diary 中）
→ 太長，浪費 Token
→ 摘要放 diary，完整報告放 docs/decisions/
```

### 3. 連結而非複製

```
✅ diary.md 中寫：
「詳細分析見 docs/decisions/2024-03-15-cache-strategy.md」

❌ 不要把完整分析複製到 diary.md
→ 保持 diary 精簡，詳細內容放別處
```

---

## 章末練習

### 🧪 動手做

1. **建立記憶系統**：在你的專案中建立 `memory/` 目錄，
   包含 `diary.md`、`patterns.md`、`context.md` 三個檔案。

2. **記錄決策**：回憶你專案中最近 3 個技術決策，
   用 Decision Diary 格式記錄下來。

3. **模式辨識**：觀察你的程式碼，找出 3 個重複出現的模式，
   記錄到 `patterns.md`。

### 🤔 思考題

1. 如果 diary 中兩條決策互相矛盾，Agent 應該怎麼做？
2. 記憶系統會不會讓 Agent 變得「保守」，不敢嘗試新方案？
3. 團隊中不同人對同一個決策有不同記憶，如何解決？

---

## 關鍵概念回顧

| 概念 | 一句話總結 |
|------|-----------|
| Decision Diary | 輕量的技術決策記錄，追蹤「為什麼」 |
| 決策生命週期 | 建立 → 驗證 → 升級或廢棄 |
| 模式記憶 | 記住有效和失敗的模式，避免重蹈覆轍 |
| 脈絡記憶 | 記住專案的背景和「為什麼」 |
| 記憶維護 | 定期清理、保持精簡、連結而非複製 |

---

> **下一章預告**：[Ch10 — 品質閘門：驗證框架](ch10-quality-gates.md)
>
> 有了原則、紅線、記憶，最後一塊拼圖是「品質閘門」——
> 一套系統化的驗證機制，確保 Agent 的每一步產出都達到標準。
