# Ch10 — 品質閘門：驗證框架

> **「信任但要驗證。」** — 雷根

---

## 🎯 本章學習目標

讀完這章，你將能夠：

- [ ] 設計 8 步驗證循環
- [ ] 為不同類型的操作設定品質標準
- [ ] 建立自動化的品質檢查管線
- [ ] 判斷何時可以信任 Agent 的產出

---

## 品質閘門是什麼？

品質閘門（Quality Gate）是 Agent 完成工作後，
在交付給你之前必須通過的一系列檢查點。

```
Agent 的工作流程：

  接收任務 → 分析 → 規劃 → 執行 → ★品質閘門★ → 交付
                                      │
                                      │ 不通過？
                                      ▼
                                    修復 → 重新驗證
```

就像工廠的品質管控：

```
原料 → 加工 → 組裝 → [QC 檢查] → 包裝 → 出貨
                        │
                        │ 不合格？
                        ▼
                      返工修復
```

---

## 8 步驗證循環

```
┌──────────────────────────────────────────────────┐
│            8 步驗證循環                             │
│                                                    │
│  Step 1  語法檢查     → 程式碼能不能跑？           │
│  Step 2  型別檢查     → 型別是否正確？             │
│  Step 3  程式碼規範   → 是否符合 Lint 規則？       │
│  Step 4  安全掃描     → 有沒有安全漏洞？           │
│  Step 5  測試執行     → 測試有沒有通過？           │
│  Step 6  效能評估     → 效能有沒有退化？           │
│  Step 7  文件檢查     → 文件有沒有更新？           │
│  Step 8  整合驗證     → 和其他系統能不能配合？     │
│                                                    │
└──────────────────────────────────────────────────┘
```

### Step 1：語法檢查

```
檢查什麼：
- 程式碼能否被解析器成功解析
- 沒有語法錯誤
- 所有括號、引號都正確配對

怎麼檢查：
- JavaScript/TypeScript: tsc --noEmit
- Python: python -m py_compile
- 建置命令: npm run build

通過標準：
✅ 零語法錯誤
```

### Step 2：型別檢查

```
檢查什麼：
- 型別是否正確
- 介面是否匹配
- 泛型是否正確使用

怎麼檢查：
- TypeScript: tsc --strict --noEmit
- Python: mypy --strict
- 型別覆蓋率工具

通過標準：
✅ 零型別錯誤
✅ 沒有 any 型別（除非有例外）
```

### Step 3：程式碼規範

```
檢查什麼：
- 命名慣例
- 程式碼格式
- 複雜度指標
- 未使用的變數和引入

怎麼檢查：
- ESLint / Prettier
- pylint / black / ruff
- 自定義規則

通過標準：
✅ 零 ESLint 錯誤
✅ 零 Prettier 差異
```

### Step 4：安全掃描

```
檢查什麼：
- 已知的安全漏洞模式
- 依賴的安全性
- OWASP Top 10
- 硬編碼的密鑰

怎麼檢查：
- npm audit
- Snyk / Dependabot
- grep 搜尋敏感字串
- semantic-deny 規則

通過標準：
✅ 無高風險漏洞
✅ 無硬編碼密鑰
```

### Step 5：測試執行

```
檢查什麼：
- 單元測試通過率
- 整合測試通過率
- 新功能的測試覆蓋率
- 回歸測試

怎麼檢查：
- npm test
- pytest
- 覆蓋率報告

通過標準：
✅ 所有測試通過
✅ 單元測試覆蓋率 ≥ 80%
✅ 整合測試覆蓋率 ≥ 70%
✅ 新增程式碼 100% 有測試
```

### Step 6：效能評估

```
檢查什麼：
- 回應時間是否增加
- 記憶體使用是否增加
- Bundle size 是否增加
- 查詢效能

怎麼檢查：
- 效能基準測試
- Lighthouse 分數
- Bundle 分析
- 查詢計畫分析

通過標準：
✅ 回應時間 < 200ms
✅ Bundle size 增量 < 5%
✅ 無 N+1 查詢
```

### Step 7：文件檢查

```
檢查什麼：
- API 文件是否更新
- README 是否反映最新狀態
- 變更日誌是否更新
- 內部文件是否同步

怎麼檢查：
- 文件和程式碼的最後修改時間比對
- API schema 和實作的一致性
- Decision Diary 更新檢查

通過標準：
✅ API 文件與實作同步
✅ 新增功能有對應文件
```

### Step 8：整合驗證

```
檢查什麼：
- 與前端的介面相容性
- 與資料庫的 Schema 一致性
- 與其他服務的 API 契約
- 部署配置的正確性

怎麼檢查：
- E2E 測試
- 契約測試
- 部署到 staging 環境
- 手動檢查關鍵流程

通過標準：
✅ E2E 測試通過
✅ API 契約一致
✅ staging 環境正常
```

---

## 不同操作的品質等級

不是每個操作都需要完整的 8 步驗證：

```
┌──────────────────────────────────────────────────┐
│         操作類型 vs 品質閘門                       │
│                                                    │
│  操作         │  必做 Steps  │  選做 Steps         │
│  ─────────────┼─────────────┼───────────────      │
│  修正錯字     │  1           │  -                  │
│  改樣式       │  1,3         │  -                  │
│  小功能       │  1,2,3,5     │  4                  │
│  中功能       │  1,2,3,4,5   │  6,7                │
│  大功能       │  1-7          │  8                  │
│  安全相關     │  1-5          │  6-8（建議全做）     │
│  DB 遷移     │  全部 1-8     │  -                  │
│                                                    │
└──────────────────────────────────────────────────┘
```

---

## 自動化品質管線

### 基本配置

把驗證步驟整合成可一鍵執行的腳本：

```json
// package.json
{
  "scripts": {
    "validate": "npm run validate:syntax && npm run validate:types && npm run validate:lint && npm run validate:security && npm run validate:test",
    "validate:syntax": "tsc --noEmit",
    "validate:types": "tsc --strict --noEmit",
    "validate:lint": "eslint . --max-warnings 0",
    "validate:security": "npm audit --audit-level=high",
    "validate:test": "vitest run --coverage"
  }
}
```

Agent 可以用一行指令執行全部檢查：

```
> 跑完整的品質驗證

Agent: [Bash: npm run validate]
       「所有品質閘門通過 ✅
        - 語法：✅
        - 型別：✅
        - Lint：✅ (0 warnings)
        - 安全：✅ (0 vulnerabilities)
        - 測試：✅ (142 passed, 0 failed)
        - 覆蓋率：87.3%」
```

### 進階：Git Hook 整合

```bash
# .husky/pre-commit
#!/bin/sh

echo "🔍 Running quality gates..."

# Step 1-3: 語法 + 型別 + 規範
npx lint-staged

# Step 4: 安全掃描
npm audit --audit-level=high
if [ $? -ne 0 ]; then
  echo "❌ Security vulnerabilities found!"
  exit 1
fi

# Step 5: 測試
npm test -- --bail
if [ $? -ne 0 ]; then
  echo "❌ Tests failed!"
  exit 1
fi

echo "✅ All quality gates passed!"
```

---

## 品質指標的追蹤

### 核心指標

```
┌──────────────────────────────────────────────────┐
│         品質儀表板                                 │
│                                                    │
│  測試覆蓋率          ████████████░░ 87%  ✅       │
│  型別覆蓋率          █████████████░ 95%  ✅       │
│  Lint 警告           0 個                 ✅       │
│  安全漏洞            0 個 (high/critical) ✅       │
│  平均回應時間        145ms                ✅       │
│  Bundle Size         423KB               ✅       │
│  技術債（預估工時）   12 小時              ⚠️       │
│                                                    │
└──────────────────────────────────────────────────┘
```

### 趨勢比紅線更重要

```
好的趨勢：
覆蓋率: 45% → 60% → 75% → 87%  ↑ 持續上升

壞的趨勢：
覆蓋率: 90% → 85% → 80% → 78%  ↓ 持續下降
（即使 78% 還「及格」，下降趨勢是警訊）
```

---

## 讓 Agent 參與品質守護

### 在 CLAUDE.md 中設定品質期望

```markdown
# 品質要求

## 每次修改後必須執行
- npm run validate（完整品質檢查）
- 確認測試覆蓋率不低於上次

## 新功能的品質標準
- 新程式碼 100% 有測試
- 符合現有命名慣例
- 無 any 型別
- 通過安全掃描

## 品質閘門觸發條件
- 修改超過 3 個檔案 → 執行完整 8 步驗證
- 修改測試檔案 → 確認覆蓋率不降低
- 新增依賴 → 執行安全掃描
```

---

## 章末練習

### 🧪 動手做

1. **建立品質管線**：在你的專案中建立一個 `npm run validate` 命令，
   至少包含語法、型別、規範、測試 4 個步驟。

2. **設定 Git Hook**：設定 pre-commit hook，
   在 commit 前自動執行品質檢查。

3. **品質評估**：用 8 步驗證循環評估你的專案目前的品質狀態，
   列出哪些步驟通過、哪些需要改善。

### 🤔 思考題

1. 品質閘門太嚴格會怎樣？太寬鬆呢？如何找到平衡？
2. 如果測試覆蓋率 100% 但全是無意義的測試，品質閘門能發現嗎？
3. 在快速迭代的早期專案中，應該啟用哪些品質閘門？

---

## 關鍵概念回顧

| 概念 | 一句話總結 |
|------|-----------|
| 品質閘門 | Agent 產出在交付前必須通過的檢查點 |
| 8 步驗證 | 語法→型別→規範→安全→測試→效能→文件→整合 |
| 品質等級 | 不同操作需要不同深度的驗證 |
| 自動化管線 | 一鍵執行所有品質檢查 |
| 趨勢追蹤 | 趨勢比紅線更重要 |

---

> **下一章預告**：[Ch11 — 多 Agent 協作：從單兵到軍團](ch11-multi-agent.md)
>
> 到目前為止，我們都在和「一個」Agent 打交道。
> 但真正的力量在於多個 Agent 的協作 —— 讓它們各司其職、互相配合。
