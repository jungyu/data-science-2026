# 第四章：複雜度門檻 — 適應性 RAG 工作流

## 學習目標

讀完本章，你將能夠：
- 解釋為什麼 RAG 任務需要分級處理流程
- 使用五問評分法評估 RAG 任務的複雜度
- 說明 Lite、Standard、Full 三種模式在 RAG 開發中的差異
- 為不同規模的 RAG 任務選擇適當的工作流程

---

## 4.1 RAG 任務的兩種失敗模式

### 過度工程（Over-engineering）
- 調整 top-k 從 3 改成 5，卻要寫完整 spec + ADR + 3 個 BDD scenario
- 結果：知識更新速度極慢，業務等不及

### 不足工程（Under-engineering）
- 直接把員工的個人信箱文件夾接入 RAG，沒有 namespace 隔離
- 結果：機密資訊洩漏，違反合規

### 解法：適應性工作流

> **根據任務的風險和複雜度，動態選擇對應的工作流程。**

---

## 4.2 五問評分法（RAG 版）

RAG 系統比一般軟體多一個維度——**知識影響範圍**，因此改為五問評分：

### 問題 1：涉及多少個知識域（Namespace）？

| 回答 | 分數 |
|------|:----:|
| 單一知識域（只改 hr-* 或只改 legal-*） | 0 |
| 跨知識域（同時影響 2 個以上 namespace） | 2 |

### 問題 2：有資料安全 / 存取權限變動？

| 回答 | 分數 |
|------|:----:|
| 無（純讀取、更新現有文件） | 0 |
| 有（新增 namespace、修改存取權限、接入新部門資料） | 3 |

### 問題 3：涉及嵌入模型或分塊策略變更？

| 回答 | 分數 |
|------|:----:|
| 否（現有文件的更新、prompt 調整） | 0 |
| 是（換模型、調整 chunking 參數、需要 re-embed） | 2 |

### 問題 4：涉及外部系統整合？

| 回答 | 分數 |
|------|:----:|
| 否（本地文件、已接入的系統） | 0 |
| 是（Confluence、SharePoint、新的 MCP Server、新的 LLM API） | 2 |

### 問題 5：影響的使用者規模？

| 回答 | 分數 |
|------|:----:|
| 小範圍（< 50 人，單一部門內部） | 0 |
| 大範圍（> 50 人，跨部門或面向客戶） | 1 |

### 分數判定

| 總分 | 模式 | 說明 |
|:----:|------|------|
| 0-2 | **Lite** | 快速更新，評估即文件 |
| 3-5 | **Standard** | 平衡規格與效率 |
| 6+ | **Full** | 完整三關 + Eval Gate |

---

## 4.3 三種模式詳解

### Lite 模式（分數 0-2）

**適用場景：**
- 更新一份現有的 HR 文件（重新嵌入）
- 調整 system prompt 的措辭
- 修正某個 chunk 的 metadata
- 調整 top-k 從 3 改成 5

**流程：**
```
確認文件符合 Constitution 的品質要求
    ↓
執行更新 + 寫簡單的 Eval 測試（Hit@3 有沒有下降？）
    ↓
更新 Action Log
```

**預估資源：** ~1,000 tokens / 30 分鐘

**💡 Lite 模式仍然需要：**
- 符合 Constitution Principle I（文件有 metadata + approved 狀態）
- 執行基本的 smoke test（查詢一個相關問題，確認答案有變）

### Standard 模式（分數 3-5）

**適用場景：**
- 新增一個知識域（例如：接入行銷部門的文件）
- 從 Confluence 自動同步頁面
- 新增一個 MCP Server

**流程：**
```
/specify → spec.md（定義 namespace、metadata schema、存取權限）
    ↓
/plan-scenarios → BDD scenarios（覆蓋正常和異常情境）
    ↓
/implement → TDD 實作
    ↓
Eval Gate → Retrieval Hit@5 達到標準
    ↓
/deploy → 上線 + 監控
```

**預估資源：** ~3,000 tokens / 1-2 天

### Full 模式（分數 6+）

**適用場景：**
- 更換嵌入模型（所有文件 re-embed）
- 接入客戶服務的外部知識庫（涉及安全和合規）
- 建立新的 RAG 系統架構

**流程：**
```
Complexity Gate（本關）→ Full 模式
    ↓
Spec Gate → 規格完整性（namespace 隔離設計？re-embed 計畫？）
    ↓
Scenario Gate → BDD 場景（安全測試？回退計畫？）
    ↓
Build Gate → TDD 實作品質
    ↓
Eval Gate → Retrieval + 答案品質評估（比較新舊模型）
    ↓
Human Review → HITL Level 1（影響 > 50 人的知識系統必須人類確認）
    ↓
Staged Rollout → 10% → 50% → 100% 流量
```

**預估資源：** ~10,000 tokens / 1-2 週

---

## 4.4 案例評估

### 案例 A：更新年假政策文件

| 問題 | 回答 | 分數 |
|------|------|:----:|
| 涉及多少知識域？ | 1 個（hr-leaves） | 0 |
| 有資料安全變動？ | 無 | 0 |
| 嵌入策略變更？ | 否（重新嵌入同 namespace） | 0 |
| 外部系統整合？ | 否 | 0 |
| 使用者規模？ | 全公司（> 50 人） | 1 |
| **總分** | | **1** |

**結論：Lite 模式**

```
執行步驟：
1. 確認文件 metadata（owner, last_updated, status=approved）✓
2. 執行 /ingest hr-policies/leave-policy-2026.pdf
3. 查詢「我有幾天年假？」確認答案已更新
4. 更新 Action Log
```

### 案例 B：接入行銷部門的品牌指南

| 問題 | 回答 | 分數 |
|------|------|:----:|
| 涉及多少知識域？ | 1 個新 namespace（marketing-*） | 0 |
| 有資料安全變動？ | 有（新增 namespace 和存取權限） | 3 |
| 嵌入策略變更？ | 否（沿用現有策略） | 0 |
| 外部系統整合？ | 否（本地 PDF） | 0 |
| 使用者規模？ | 行銷部門（< 50 人） | 0 |
| **總分** | | **3** |

**結論：Standard 模式**

### 案例 C：更換嵌入模型（全面 re-embed）

| 問題 | 回答 | 分數 |
|------|------|:----:|
| 涉及多少知識域？ | 全部 namespace | 2 |
| 有資料安全變動？ | 有（涉及所有部門文件） | 3 |
| 嵌入策略變更？ | 是（換模型 = 全部 re-embed） | 2 |
| 外部系統整合？ | 是（新 OpenAI 模型 API） | 2 |
| 使用者規模？ | 全公司（> 50 人） | 1 |
| **總分** | | **10** |

**結論：Full 模式**

---

## 4.5 RAG Complexity Gate 的設計原理

RAG 版的 Complexity Gate 在原版的四個問題基礎上加入了「使用者規模」，  
原因是：知識系統的錯誤影響比一般軟體更廣泛。

一個普通程式的 bug，影響的是使用這個功能的用戶。  
一個 RAG 系統的知識錯誤，影響的是所有查詢相關知識的用戶，  
而且他們通常不知道 AI 正在引用錯誤的資訊。

**RAG 複雜度的核心維度：**
1. **知識廣度**：影響幾個 namespace？
2. **安全風險**：有沒有存取控制的變動？
3. **技術影響**：是否需要重新嵌入大量文件？
4. **整合複雜度**：涉及幾個外部系統？
5. **影響規模**：多少用戶依賴這個知識？

---

## 練習

1. **評估練習**：為以下三個任務做複雜度評估（使用五問評分法）：
   - (a) 更新客服知識庫中一份產品說明書（現有系統，現有 namespace）
   - (b) 將公司的 Slack 討論記錄接入 RAG（全新整合）
   - (c) 把 RAG 系統從 Chroma 遷移到 Pinecone（向量 DB 更換）

2. **設計練習**：如果你覺得五個問題不夠，你會為「企業 RAG 系統」增加什麼評估問題？說明為什麼。

3. **思考題**：一個任務被評為 Lite 模式開始執行，但執行途中發現文件包含機密的薪資資訊，需要額外的存取控制。這時候應該怎麼處理？直接升級到 Standard 嗎？需要通知誰？

4. **流程設計**：為一家 100 人的新創公司，設計一份「RAG 知識庫維護 SOP」，說明什麼情況走 Lite、什麼情況走 Standard、什麼情況需要 Full 模式。

---

> **下一章**：[第五章：契約先行 — 知識 API 的合約治理](05-design-by-contract.md)  
> 我們將學習如何用「合約」的概念確保知識攝取、檢索、生成三個環節保持一致。
