# ============================================================
# Contract First Gate — 契約優先守門規則
# ============================================================
# 確保所有 API、型別、Schema 變更皆先更新契約文件。
# 契約是系統的 single source of truth。
# ============================================================

id: gov.contract_first_gate.v1
version: "1.0.0"
name: "契約優先守門"
description: |
  任何涉及 API 端點、核心型別、資料庫 Schema 的變更，
  必須先更新對應的契約文件（contracts/），再修改實作程式碼。
  違反此規則將觸發 block，防止契約與實作不同步。

scope:
  applies_to:
    - "contracts/**"
    - "migrations/**"
    - "{{SRC_DIR}}/**"
    - "{{API_DIR}}/**"
  trigger_on:
    - file_create
    - file_modify
    - file_delete

# ------------------------------------------------------------
# 規則定義
# ------------------------------------------------------------
rules:

  - id: R1
    name: "API 或原始碼變更必須同步契約"
    description: |
      當 {{API_DIR}}/** 或 {{SRC_DIR}}/** 中的檔案涉及
      API endpoint 簽章、request/response 型別、或公開介面變更時，
      contracts/ 目錄下對應的契約文件必須在同一 commit 中更新。
    severity: error
    condition: |
      changed_files INTERSECT ["{{API_DIR}}/**", "{{SRC_DIR}}/**"]
      AND changes_affect(api_signature OR public_interface OR request_response_type)
      AND NOT changed_files INTERSECT ["contracts/**"]
    action: block
    message: |
      ❌ 偵測到 API 或公開介面變更，但 contracts/ 未同步更新。
      請先更新對應的契約文件，確保契約與實作一致。

  - id: R2
    name: "核心型別或 Schema 變更須版本升級"
    description: |
      核心型別定義（如共用 interface、enum、domain model）或
      資料 Schema 變更時，必須在契約文件中進行版本升級（version bump）。
      這確保下游消費者能感知到 breaking change。
    severity: error
    condition: |
      changed_files INTERSECT ["contracts/**"]
      AND changes_affect(core_type OR schema_definition)
      AND NOT version_bumped(contracts)
    action: block
    message: |
      ❌ 偵測到核心型別或 Schema 變更，但契約版本未升級。
      請在契約文件中更新 version 欄位（遵循 semver）。

  - id: R3
    name: "資料庫 Schema 變更須附 migration 與契約更新"
    description: |
      任何資料庫 Schema 變更（新增表、修改欄位、變更索引）
      必須同時提供 migration 檔案與更新對應的契約文件。
    severity: error
    condition: |
      changes_affect(database_schema)
      AND NOT (
        changed_files INTERSECT ["migrations/**"]
        AND changed_files INTERSECT ["contracts/**"]
      )
    action: block
    message: |
      ❌ 偵測到資料庫 Schema 變更，但缺少 migration 或契約更新。
      請同時提供：
      1. migrations/ 下的 migration 檔案
      2. contracts/ 下對應的契約文件更新

# ------------------------------------------------------------
# 豁免條件
# ------------------------------------------------------------
exemptions:
  - description: "純文件/註解變更不觸發此規則"
    condition: changes_only_affect(comments OR documentation)
  - description: "測試檔案不觸發此規則"
    condition: all_changed_files_match("**/*.test.*", "**/*.spec.*", "**/__tests__/**")
  - description: "附有核准的 ADR 豁免編號可跳過"
    condition: commit_message CONTAINS "ADR-EXEMPT:"

# ------------------------------------------------------------
# 自動修正建議
# ------------------------------------------------------------
suggestions:
  - trigger: R1
    hint: |
      建議步驟：
      1. 確認變更涉及的 API endpoint 或公開介面
      2. 在 contracts/ 下找到或建立對應的契約文件
      3. 更新契約文件以反映新的簽章或型別
      4. 確保契約與實作在同一 commit 中提交

  - trigger: R2
    hint: |
      建議步驟：
      1. 判斷變更為 breaking (major) / 新增 (minor) / 修正 (patch)
      2. 更新契約文件中的 version 欄位
      3. 若為 breaking change，在 CHANGELOG 中記錄

  - trigger: R3
    hint: |
      建議步驟：
      1. 使用專案的 migration 工具產生 migration 檔案
      2. 更新 contracts/ 下的資料模型契約
      3. 確認 migration 包含 up 與 down（可回滾）
