# ============================================================
# Style Canon Enforcer â€” é¢¨æ ¼è¦ç¯„å¼·åˆ¶åŸ·è¡Œè¦å‰‡
# ============================================================
# ç¢ºä¿æ‰€æœ‰æ–°å¢ç¨‹å¼ç¢¼éµå¾ªå°ˆæ¡ˆæ—¢æœ‰çš„å‘½åã€éŒ¯èª¤è™•ç†ã€
# logging èˆ‡ CSS åˆä½µæ…£ä¾‹ï¼Œé˜²æ­¢é¢¨æ ¼ç¢ç‰‡åŒ–ã€‚
# ============================================================

id: gov.style_canon_enforcer.v1
version: "1.0.0"
name: "é¢¨æ ¼è¦ç¯„å¼·åˆ¶åŸ·è¡Œ"
description: |
  åŒä¸€æ¨¡çµ„å…§ç¦æ­¢æ··ç”¨å¤šç¨® async patternã€error handling pattern æˆ– naming conventionã€‚
  æ‰€æœ‰æ–°å¢ç¨‹å¼ç¢¼å¿…é ˆéµå¾ªå°ˆæ¡ˆçš„ style canonï¼Œç¢ºä¿ä¸€è‡´æ€§èˆ‡å¯ç¶­è­·æ€§ã€‚

scope:
  applies_to:
    - "{{SRC_DIR}}/**"
    - "{{API_DIR}}/**"
    - "components/**"
  trigger_on:
    - file_create
    - file_modify

# ------------------------------------------------------------
# é¢¨æ ¼è¦ç¯„åƒè€ƒ
# ------------------------------------------------------------
style_canon:
  reference_path: "{{STYLE_CANON_PATH}}"
  naming:
    files: "{{FILE_NAMING_CONVENTION}}"           # ä¾‹ï¼škebab-case, PascalCase, camelCase
    components: "{{COMPONENT_NAMING_CONVENTION}}"  # ä¾‹ï¼šPascalCase
    functions: "{{FUNCTION_NAMING_CONVENTION}}"    # ä¾‹ï¼šcamelCase
    constants: "{{CONSTANT_NAMING_CONVENTION}}"    # ä¾‹ï¼šUPPER_SNAKE_CASE
    types: "{{TYPE_NAMING_CONVENTION}}"            # ä¾‹ï¼šPascalCase with I/T prefix or none
  error_handling:
    module: "{{ERROR_TYPE_MODULE}}"                # çµ±ä¸€éŒ¯èª¤å‹åˆ¥æ¨¡çµ„
    pattern: "{{ERROR_PATTERN}}"                   # ä¾‹ï¼šResult<T, E>, throw AppError, try/catch
  logging:
    module: "{{LOGGING_UTILITY}}"                  # é›†ä¸­å¼ logging å·¥å…·
    levels: ["debug", "info", "warn", "error"]
  css_merge:
    utility: "{{CSS_MERGE_UTILITY}}"               # CSS class åˆä½µå·¥å…·

# ------------------------------------------------------------
# è¦å‰‡å®šç¾©
# ------------------------------------------------------------
rules:

  - id: S1
    name: "æ–°æª”æ¡ˆå‘½åå¿…é ˆéµå¾ª style canon"
    description: |
      æ‰€æœ‰æ–°å»ºæª”æ¡ˆçš„å‘½åå¿…é ˆç¬¦åˆå°ˆæ¡ˆ style canon ä¸­å®šç¾©çš„æ…£ä¾‹ã€‚
      åŒ…å«æª”æ¡ˆåç¨±ã€åŒ¯å‡ºçš„ function/class/type åç¨±ã€‚
    severity: error
    condition: |
      file_is_new
      AND file_path MATCH ["{{SRC_DIR}}/**", "{{API_DIR}}/**", "components/**"]
      AND NOT naming_follows_convention(style_canon.naming)
    action: warn
    message: |
      âš ï¸ æ–°æª”æ¡ˆå‘½åä¸ç¬¦åˆ style canonã€‚
      è«‹åƒè€ƒ {{STYLE_CANON_PATH}} ä¸­çš„å‘½åæ…£ä¾‹ï¼š
      - æª”æ¡ˆï¼š{{FILE_NAMING_CONVENTION}}
      - å…ƒä»¶ï¼š{{COMPONENT_NAMING_CONVENTION}}
      - å‡½å¼ï¼š{{FUNCTION_NAMING_CONVENTION}}
      - å¸¸æ•¸ï¼š{{CONSTANT_NAMING_CONVENTION}}
      - å‹åˆ¥ï¼š{{TYPE_NAMING_CONVENTION}}

  - id: S2
    name: "æ–°éŒ¯èª¤è™•ç†å¿…é ˆä½¿ç”¨æŒ‡å®šçš„éŒ¯èª¤å‹åˆ¥"
    description: |
      æ‰€æœ‰æ–°å¢çš„éŒ¯èª¤è™•ç†ç¨‹å¼ç¢¼å¿…é ˆä½¿ç”¨å°ˆæ¡ˆæŒ‡å®šçš„çµ±ä¸€éŒ¯èª¤å‹åˆ¥ï¼Œ
      é¿å…è‡ªè¡Œå®šç¾© Error class æˆ–ä½¿ç”¨åŸç”Ÿ Error æ­é…å­—ä¸²è¨Šæ¯ã€‚
    severity: error
    condition: |
      changes_introduce(error_handling)
      AND NOT uses_module(style_canon.error_handling.module)
      AND NOT file_path MATCH [style_canon.error_handling.module]
    action: warn
    message: |
      âš ï¸ åµæ¸¬åˆ°æ–°å¢çš„éŒ¯èª¤è™•ç†æœªä½¿ç”¨æŒ‡å®šçš„éŒ¯èª¤å‹åˆ¥ã€‚
      è«‹ä½¿ç”¨ {{ERROR_TYPE_MODULE}} ä¸­å®šç¾©çš„éŒ¯èª¤å‹åˆ¥ï¼Œè€Œéï¼š
      - è‡ªè¡Œå®šç¾©çš„ Error class
      - åŸç”Ÿ Error + å­—ä¸²è¨Šæ¯
      - æœªåˆ†é¡çš„ throw

  - id: S3
    name: "æ–° logging å¿…é ˆä½¿ç”¨é›†ä¸­å¼ logging å·¥å…·"
    description: |
      æ‰€æœ‰æ–°å¢çš„ logging å¿…é ˆä½¿ç”¨å°ˆæ¡ˆçš„é›†ä¸­å¼ logging å·¥å…·ï¼Œ
      é¿å…ç›´æ¥ä½¿ç”¨ console.log/warn/error æˆ–å…¶ä»– logging libraryã€‚
    severity: warning
    condition: |
      changes_introduce(logging)
      AND uses_direct_console(["console.log", "console.warn", "console.error", "console.info"])
      AND NOT file_path MATCH ["{{LOGGING_UTILITY}}", "**/*.test.*", "**/*.spec.*"]
    action: warn
    message: |
      âš ï¸ åµæ¸¬åˆ°ç›´æ¥ä½¿ç”¨ console.* é€²è¡Œ loggingã€‚
      è«‹æ”¹ç”¨ {{LOGGING_UTILITY}} æä¾›çš„ logging å‡½å¼ï¼Œç¢ºä¿ï¼š
      - çµ±ä¸€çš„ log æ ¼å¼èˆ‡ level æ§åˆ¶
      - ç”Ÿç”¢ç’°å¢ƒçš„ log éæ¿¾
      - çµæ§‹åŒ– loggingï¼ˆå« context metadataï¼‰

  - id: S4
    name: "CSS class åˆä½µå¿…é ˆä½¿ç”¨æŒ‡å®šå·¥å…·"
    description: |
      æ‰€æœ‰å‹•æ…‹ CSS class åˆä½µå¿…é ˆä½¿ç”¨å°ˆæ¡ˆæŒ‡å®šçš„å·¥å…·å‡½å¼ï¼Œ
      é¿å…æ‰‹å‹•å­—ä¸²æ‹¼æ¥æˆ–ä½¿ç”¨å…¶ä»– class merge libraryã€‚
    severity: warning
    condition: |
      changes_introduce(css_class_merging)
      AND NOT uses_utility(style_canon.css_merge.utility)
      AND file_path MATCH ["components/**", "{{SRC_DIR}}/**"]
    action: warn
    message: |
      âš ï¸ åµæ¸¬åˆ° CSS class åˆä½µæœªä½¿ç”¨æŒ‡å®šå·¥å…·ã€‚
      è«‹æ”¹ç”¨ {{CSS_MERGE_UTILITY}} é€²è¡Œ class åˆä½µï¼Œè€Œéï¼š
      - æ‰‹å‹•å­—ä¸²æ‹¼æ¥ï¼ˆ`className={a + " " + b}`ï¼‰
      - template literal æ‹¼æ¥ï¼ˆ`className={\`${a} ${b}\`}`ï¼‰
      - å…¶ä»– class merge library

# ------------------------------------------------------------
# å°é–æ¢ä»¶ï¼ˆç¡¬æ€§é˜»æ“‹ï¼‰
# ------------------------------------------------------------
blocks:
  - id: S_BLOCK_1
    name: "ç¦æ­¢åŒä¸€æ¨¡çµ„æ··ç”¨ 2+ async/error patterns"
    description: |
      åŒä¸€æ¨¡çµ„ï¼ˆç›®éŒ„ï¼‰å…§ä¸å¾—åŒæ™‚å­˜åœ¨å…©ç¨®ä»¥ä¸Šçš„ async pattern
      æˆ– error handling patternã€‚é€™æ˜¯é˜²æ­¢é¢¨æ ¼ç¢ç‰‡åŒ–çš„ç¡¬æ€§è¦å‰‡ã€‚
    condition: |
      module_contains(async_patterns, count >= 2)
      OR module_contains(error_patterns, count >= 2)
    action: block
    message: |
      ğŸš¨ å°é–ï¼šåŒä¸€æ¨¡çµ„æ··ç”¨ 2+ async/error patternsã€‚

      åµæ¸¬åˆ°çš„æ··ç”¨æƒ…æ³ï¼š
      - æ¨¡çµ„è·¯å¾‘ï¼š{module_path}
      - ç™¼ç¾çš„ patternsï¼š{detected_patterns}

      è«‹çµ±ä¸€ç‚ºå°ˆæ¡ˆæŒ‡å®šçš„ patternï¼Œåƒè€ƒ {{STYLE_CANON_PATH}}ã€‚

  - id: S_BLOCK_2
    name: "ç¦æ­¢ magic strings æœªé›†ä¸­ç®¡ç†"
    description: |
      é‡è¤‡å‡ºç¾çš„å­—ä¸²å¸¸æ•¸ï¼ˆmagic stringsï¼‰å¿…é ˆé›†ä¸­å®šç¾©æ–¼å¸¸æ•¸æ¨¡çµ„ï¼Œ
      ä¸å¾—æ•£è½åœ¨å¤šå€‹æª”æ¡ˆä¸­ã€‚
    condition: |
      string_literal_appears_in(files, count >= 3)
      AND string_is_not_centralized
      AND string_length > 3
    action: warn
    message: |
      âš ï¸ åµæ¸¬åˆ° magic string æœªé›†ä¸­ç®¡ç†ã€‚
      å­—ä¸² "{string_value}" å‡ºç¾åœ¨ {count} å€‹æª”æ¡ˆä¸­ã€‚
      è«‹å°‡å…¶æå–è‡³å¸¸æ•¸æ¨¡çµ„ä¸¦çµ±ä¸€å¼•ç”¨ã€‚

# ------------------------------------------------------------
# è±å…æ¢ä»¶
# ------------------------------------------------------------
exemptions:
  - description: "æ¸¬è©¦æª”æ¡ˆä¸­çš„ console.log ä¸è§¸ç™¼ S3"
    condition: file_path MATCH "**/*.test.*" OR file_path MATCH "**/*.spec.*"
  - description: "é–‹ç™¼å·¥å…·èˆ‡ script ä¸è§¸ç™¼å‘½åè¦å‰‡"
    condition: file_path MATCH "scripts/**" OR file_path MATCH "tools/**"
  - description: "ç¬¬ä¸‰æ–¹æ•´åˆå±¤å…è¨±éµå¾ªç¬¬ä¸‰æ–¹å‘½åæ…£ä¾‹"
    condition: file_path MATCH "**/integrations/**" OR file_path MATCH "**/adapters/**"

# ------------------------------------------------------------
# è‡ªå‹•ä¿®æ­£å»ºè­°
# ------------------------------------------------------------
suggestions:
  - trigger: S1
    hint: |
      è«‹æ ¹æ“š {{STYLE_CANON_PATH}} é‡æ–°å‘½åæª”æ¡ˆèˆ‡åŒ¯å‡ºã€‚
      ä½¿ç”¨å°ˆæ¡ˆçš„ rename scriptï¼ˆè‹¥æœ‰ï¼‰ç¢ºä¿æ‰€æœ‰å¼•ç”¨åŒæ­¥æ›´æ–°ã€‚

  - trigger: S2
    hint: |
      å»ºè­°æ­¥é©Ÿï¼š
      1. å¼•å…¥ {{ERROR_TYPE_MODULE}} ä¸­çš„éŒ¯èª¤å‹åˆ¥
      2. å°‡è‡ªè¨‚ Error æ›¿æ›ç‚ºå°ˆæ¡ˆæ¨™æº–éŒ¯èª¤å‹åˆ¥
      3. ç¢ºä¿éŒ¯èª¤åŒ…å«è¶³å¤ çš„ context è³‡è¨Š

  - trigger: S3
    hint: |
      å»ºè­°æ­¥é©Ÿï¼š
      1. å¼•å…¥ {{LOGGING_UTILITY}} ä¸­çš„ logger
      2. å°‡ console.* æ›¿æ›ç‚º logger å°æ‡‰çš„ level æ–¹æ³•
      3. åŠ å…¥çµæ§‹åŒ– contextï¼ˆå¦‚ module name, operationï¼‰

  - trigger: S4
    hint: |
      å»ºè­°æ­¥é©Ÿï¼š
      1. å¼•å…¥ {{CSS_MERGE_UTILITY}}
      2. å°‡å­—ä¸²æ‹¼æ¥æ›¿æ›ç‚ºå·¥å…·å‡½å¼å‘¼å«
      3. ç¢ºä¿æ¢ä»¶å¼ class ä½¿ç”¨å·¥å…·æ”¯æ´çš„èªæ³•
