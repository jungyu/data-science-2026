# ============================================================
# AI Quarantine & Merge â€” AI ç¨‹å¼ç¢¼éš”é›¢èˆ‡æ•´ä½µè¦å‰‡
# ============================================================
# ç¢ºä¿ AI ç”Ÿæˆçš„ç¨‹å¼ç¢¼ç¶“ééš”é›¢ã€å¯©æŸ¥ã€é‡æ§‹å¾Œæ‰é€²å…¥ç”Ÿç”¢è·¯å¾‘ã€‚
# AI æ˜¯å·¥å…·ï¼Œä¸æ˜¯ç›´æ¥çš„ committerã€‚
# ============================================================

id: gov.ai_quarantine_merge.v1
version: "1.0.0"
name: "AI ç¨‹å¼ç¢¼éš”é›¢èˆ‡æ•´ä½µ"
description: |
  AI ç”¢ç”Ÿçš„ç¨‹å¼ç¢¼å¿…é ˆå…ˆé€²å…¥éš”é›¢å€ï¼ˆai-generated/ï¼‰ï¼Œ
  ç¶“äººé¡å¯©æŸ¥ã€é‡æ§‹ã€æ¸¬è©¦å¾Œæ‰å¯æ•´ä½µè‡³ç”Ÿç”¢ç¨‹å¼ç¢¼ã€‚
  é€™ç¢ºä¿ AI ç”Ÿæˆç‰©ç¬¦åˆå°ˆæ¡ˆæ…£ä¾‹ã€å“è³ªæ¨™æº–èˆ‡æ¶æ§‹æ–¹å‘ã€‚

scope:
  applies_to:
    - "ai-generated/**"
    - "{{SRC_DIR}}/**"
    - "{{API_DIR}}/**"
  trigger_on:
    - file_create
    - file_modify

# ------------------------------------------------------------
# éš”é›¢å€çµæ§‹
# ------------------------------------------------------------
quarantine_structure:
  base_path: "ai-generated/"
  naming_convention: "ai-generated/<YYYY-MM-DD>/<topic>/"
  required_files:
    - "README.md"          # èªªæ˜ç”Ÿæˆç›®çš„ã€prompt æ‘˜è¦ã€é æœŸç”¨é€”
    - "merge-plan.md"      # æ•´ä½µè¨ˆç•«ï¼šç›®æ¨™è·¯å¾‘ã€é‡æ§‹æ¸…å–®ã€æ¸¬è©¦è¨ˆç•«
  optional_files:
    - "prompt-log.md"      # å®Œæ•´ prompt è¨˜éŒ„ï¼ˆä¾›æ—¥å¾Œåƒè€ƒï¼‰
    - "diff-notes.md"      # èˆ‡ç¾æœ‰ç¨‹å¼ç¢¼çš„å·®ç•°åˆ†æ

# ------------------------------------------------------------
# è¦å‰‡å®šç¾©
# ------------------------------------------------------------
rules:

  - id: Q1
    name: "æ–° AI ç”Ÿæˆç¨‹å¼ç¢¼å¿…é ˆé€²å…¥éš”é›¢å€"
    description: |
      ä»»ä½•ç”± AI å·¥å…·ï¼ˆCopilotã€Claudeã€ChatGPT ç­‰ï¼‰ç”Ÿæˆçš„æ–°ç¨‹å¼ç¢¼ï¼Œ
      å¿…é ˆå…ˆæ”¾ç½®æ–¼ ai-generated/<date>/<topic>/ ç›®éŒ„ä¸‹ï¼Œ
      ä¸¦é™„ä¸Š README.md èªªæ˜ç”Ÿæˆç›®çš„ã€‚
    severity: error
    condition: |
      file_is_ai_generated
      AND file_path NOT MATCH "ai-generated/**"
      AND file_is_new
      AND NOT exempted
    action: warn
    message: |
      âš ï¸ åµæ¸¬åˆ°æ–°å¢çš„ AI ç”Ÿæˆç¨‹å¼ç¢¼æœªé€²å…¥éš”é›¢å€ã€‚
      è«‹å°‡æª”æ¡ˆç§»è‡³ ai-generated/<date>/<topic>/ ä¸¦é™„ä¸Š README.mdã€‚

      éš”é›¢å€çµæ§‹ï¼š
      ai-generated/
      â””â”€â”€ YYYY-MM-DD/
          â””â”€â”€ <topic>/
              â”œâ”€â”€ README.md       # ç”Ÿæˆç›®çš„èˆ‡ prompt æ‘˜è¦
              â”œâ”€â”€ merge-plan.md   # æ•´ä½µè¨ˆç•«
              â””â”€â”€ <generated-files>

  - id: Q2
    name: "AI ç¨‹å¼ç¢¼é€²å…¥ç”Ÿç”¢è·¯å¾‘é ˆé™„é‡æ§‹ PR è¨ˆç•«"
    description: |
      å°‡ AI ç”Ÿæˆçš„ç¨‹å¼ç¢¼å¾éš”é›¢å€ç§»è‡³ç”Ÿç”¢è·¯å¾‘æ™‚ï¼Œ
      å¿…é ˆå»ºç«‹é‡æ§‹ PRï¼ˆPull Requestï¼‰ä¸¦é™„ä¸Šï¼š
      - é‡æ§‹å…§å®¹æ‘˜è¦ï¼ˆèˆ‡åŸå§‹ç”Ÿæˆç‰©çš„å·®ç•°ï¼‰
      - ç¬¦åˆå°ˆæ¡ˆ style canon çš„ç¢ºèª
      - æ¸¬è©¦è¦†è“‹è­‰æ˜
    severity: error
    condition: |
      source_is_quarantine("ai-generated/**")
      AND target_is_production(["{{SRC_DIR}}/**", "{{API_DIR}}/**"])
      AND NOT has_merge_plan
    action: block
    message: |
      âŒ AI ç”Ÿæˆç¨‹å¼ç¢¼ç§»å…¥ç”Ÿç”¢è·¯å¾‘ä½†ç¼ºå°‘é‡æ§‹è¨ˆç•«ã€‚
      è«‹ç¢ºä¿ï¼š
      1. ai-generated/<date>/<topic>/merge-plan.md å·²å®Œæˆ
      2. PR æè¿°ä¸­åˆ—å‡ºæ‰€æœ‰é‡æ§‹é …ç›®
      3. æ–°å¢çš„ç¨‹å¼ç¢¼é€šé lintã€type checkã€æ¸¬è©¦

  - id: Q3
    name: "AI ç¨‹å¼ç¢¼è§¸åŠæ ¸å¿ƒæ¨¡çµ„é ˆé™„ ADR æˆ– Intent èªªæ˜"
    description: |
      ç•¶ AI ç”Ÿæˆçš„ç¨‹å¼ç¢¼æ¶‰åŠæ ¸å¿ƒæ¨¡çµ„ï¼ˆå¦‚èªè­‰ã€è³‡æ–™å­˜å–ã€æ ¸å¿ƒæ¥­å‹™é‚è¼¯ï¼‰æ™‚ï¼Œ
      å¿…é ˆé¡å¤–å»ºç«‹ ADR æˆ–åœ¨ commit message ä¸­é™„ Intent èªªæ˜ï¼Œ
      è¨˜éŒ„ç‚ºä½•ä½¿ç”¨ AI ç”Ÿæˆæ­¤éƒ¨åˆ†ä»¥åŠäººé¡å¯©æŸ¥çš„é‡é»ã€‚
    severity: error
    condition: |
      source_is_ai_generated
      AND target_touches_critical_module(["{{SRC_DIR}}/core/**", "{{SRC_DIR}}/auth/**", "{{SRC_DIR}}/data/**"])
      AND NOT (
        changed_files INTERSECT ["{{ADR_DIR}}/**"]
        OR commit_message CONTAINS "AI-INTENT:"
      )
    action: block
    message: |
      âŒ AI ç”Ÿæˆç¨‹å¼ç¢¼è§¸åŠæ ¸å¿ƒæ¨¡çµ„ä½†ç¼ºå°‘ ADR æˆ– Intent èªªæ˜ã€‚
      è«‹é¸æ“‡ä»¥ä¸‹å…¶ä¸€ï¼š
      1. åœ¨ {{ADR_DIR}}/ ä¸‹å»ºç«‹ ADRï¼Œèªªæ˜ AI ç”Ÿæˆçš„ç¯„åœèˆ‡å¯©æŸ¥é‡é»
      2. åœ¨ commit message ä¸­åŠ å…¥ AI-INTENT: æ¨™è¨˜ï¼Œèªªæ˜æ±ºç­–ç†ç”±

# ------------------------------------------------------------
# å°é–æ¢ä»¶ï¼ˆç¡¬æ€§é˜»æ“‹ï¼‰
# ------------------------------------------------------------
blocks:
  - id: Q_BLOCK_1
    name: "ç¦æ­¢ AI ç›´æ¥ä¿®æ”¹ç”Ÿç”¢ç¨‹å¼ç¢¼ä¸”ç„¡éš”é›¢è¨ˆç•«"
    description: |
      AI ä¸å¾—ç›´æ¥ä¿®æ”¹ {{SRC_DIR}}/** ä¸‹çš„æª”æ¡ˆä¸”æ²’æœ‰éš”é›¢èˆ‡æ•´ä½µè¨ˆç•«ã€‚
      é€™æ˜¯é˜²æ­¢ AI ç”Ÿæˆç‰©æœªç¶“å¯©æŸ¥ç›´æ¥é€²å…¥ç”Ÿç”¢ç’°å¢ƒçš„æœ€å¾Œé˜²ç·šã€‚
    condition: |
      actor = ai_agent
      AND changed_files INTERSECT ["{{SRC_DIR}}/**"]
      AND NOT has_quarantine_plan
      AND NOT has_merge_plan
    action: block
    message: |
      ğŸš¨ å°é–ï¼šAI ç›´æ¥ä¿®æ”¹ {{SRC_DIR}}/** ä¸”æ²’æœ‰éš”é›¢èˆ‡æ•´ä½µè¨ˆç•«ã€‚

      æ‰€æœ‰ AI ç”Ÿæˆçš„ç”Ÿç”¢ç¨‹å¼ç¢¼å¿…é ˆï¼š
      1. å…ˆé€²å…¥ ai-generated/ éš”é›¢å€
      2. é™„ä¸Š merge-plan.md æ•´ä½µè¨ˆç•«
      3. ç¶“äººé¡å¯©æŸ¥å¾Œé€éé‡æ§‹ PR æ•´ä½µ

# ------------------------------------------------------------
# è±å…æ¢ä»¶
# ------------------------------------------------------------
exemptions:
  - description: "AI ç”Ÿæˆçš„æ¸¬è©¦æª”æ¡ˆå¯ç›´æ¥é€²å…¥æ¸¬è©¦ç›®éŒ„"
    condition: file_path MATCH "**/*.test.*" OR file_path MATCH "**/*.spec.*"
  - description: "AI ç”Ÿæˆçš„æ–‡ä»¶å¯ç›´æ¥é€²å…¥ docs/"
    condition: file_path MATCH "docs/**"
  - description: "AI è¼”åŠ©çš„å°å¹…ä¿®æ­£ï¼ˆ< 10 è¡Œè®Šæ›´ï¼‰å¯ç›´æ¥æäº¤"
    condition: change_size < 10 AND change_type = modification
  - description: "é™„æœ‰ AI-REVIEWED: æ¨™è¨˜çš„å·²å¯©æŸ¥ç¨‹å¼ç¢¼å¯è·³ééš”é›¢"
    condition: commit_message CONTAINS "AI-REVIEWED:"

# ------------------------------------------------------------
# è‡ªå‹•ä¿®æ­£å»ºè­°
# ------------------------------------------------------------
suggestions:
  - trigger: Q1
    hint: |
      å»ºè­°æ­¥é©Ÿï¼š
      1. å»ºç«‹ç›®éŒ„ï¼šai-generated/$(date +%Y-%m-%d)/<topic>/
      2. å°‡ AI ç”Ÿæˆçš„æª”æ¡ˆç§»å…¥è©²ç›®éŒ„
      3. æ’°å¯« README.mdï¼ˆç›®çš„ã€prompt æ‘˜è¦ã€é æœŸç”¨é€”ï¼‰
      4. æ’°å¯« merge-plan.mdï¼ˆç›®æ¨™è·¯å¾‘ã€é‡æ§‹é …ç›®ã€æ¸¬è©¦è¨ˆç•«ï¼‰

  - trigger: Q2
    hint: |
      å»ºè­°æ­¥é©Ÿï¼š
      1. å®Œæˆ merge-plan.md ä¸­çš„æ‰€æœ‰é‡æ§‹é …ç›®
      2. ç¢ºèªç¨‹å¼ç¢¼ç¬¦åˆ {{STYLE_CANON_PATH}} è¦ç¯„
      3. è£œå……æ¸¬è©¦è¦†è“‹ï¼ˆè‡³å°‘æ¶µè“‹ happy path + error pathï¼‰
      4. å»ºç«‹ PR ä¸¦åœ¨æè¿°ä¸­å¼•ç”¨ merge-plan.md

  - trigger: Q3
    hint: |
      å»ºè­°æ­¥é©Ÿï¼š
      1. è©•ä¼° AI ç”Ÿæˆçš„æ ¸å¿ƒæ¨¡çµ„ç¨‹å¼ç¢¼å“è³ªèˆ‡å®‰å…¨æ€§
      2. é¸æ“‡ ADR æˆ– AI-INTENT æ¨™è¨˜è¨˜éŒ„æ±ºç­–
      3. åœ¨ PR ä¸­ç‰¹åˆ¥æ¨™è¨˜éœ€è¦é‡é»å¯©æŸ¥çš„å€å¡Š
