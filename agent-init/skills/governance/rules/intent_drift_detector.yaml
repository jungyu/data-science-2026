# ============================================================
# Intent Drift Detector â€” æ„åœ–æ¼‚ç§»åµæ¸¬è¦å‰‡
# ============================================================
# åµæ¸¬åé›¢å¹³å°æ ¸å¿ƒæ„åœ–çš„è®Šæ›´ï¼Œé˜²æ­¢ç³»çµ±æ¼”åŒ–æ–¹å‘å¤±æ§ã€‚
# ç³»çµ±æ¼”åŒ–å¿…é ˆæ²¿è‘— intent map å®šç¾©çš„æ–¹å‘å‰é€²ã€‚
# ============================================================

id: gov.intent_drift_detector.v1
version: "1.0.0"
name: "æ„åœ–æ¼‚ç§»åµæ¸¬"
description: |
  é€é intent mapï¼ˆå¹³å°ç›®çš„ã€ä¸å¯å¦¥å”é …ã€æ“´å±•å‘é‡ï¼‰åµæ¸¬
  å¯èƒ½å°è‡´å¹³å°æ–¹å‘æ¼‚ç§»çš„è®Šæ›´ã€‚ä»»ä½•åé›¢ non-negotiables
  çš„è®Šæ›´å¿…é ˆé™„å¸¶è£œæ•‘æ–¹æ¡ˆæˆ–æ˜ç¢ºçš„è±å…ç†ç”±ã€‚

scope:
  applies_to:
    - "{{SRC_DIR}}/**"
    - "{{API_DIR}}/**"
    - "contracts/**"
    - "package.json"
    - "docs/intent/**"
  trigger_on:
    - file_create
    - file_modify
    - file_delete

# ------------------------------------------------------------
# Intent Map å®šç¾©
# ------------------------------------------------------------
intent_map:
  paths:
    platform_purpose: "docs/intent/platform-purpose.md"
    non_negotiables: "docs/intent/non-negotiables.md"
    expansion_vector: "docs/intent/expansion-vector.md"

  description: |
    Intent map ç”±ä¸‰ä»½æ–‡ä»¶çµ„æˆï¼š
    1. platform-purpose.md â€” å¹³å°å­˜åœ¨çš„æ ¸å¿ƒç†ç”±èˆ‡ç›®æ¨™å—çœ¾
    2. non-negotiables.md â€” ä¸å¯å¦¥å”çš„æŠ€è¡“èˆ‡ç”¢å“ç´„æŸ
    3. expansion-vector.md â€” å…è¨±çš„æ“´å±•æ–¹å‘èˆ‡å„ªå…ˆé †åº

  setup_guide: |
    é¦–æ¬¡ä½¿ç”¨æ™‚ï¼Œè«‹å»ºç«‹ä»¥ä¸‹ä¸‰ä»½æ–‡ä»¶ï¼š

    docs/intent/platform-purpose.md:
      - å¹³å°çš„æ ¸å¿ƒä½¿å‘½ï¼ˆä¸€å¥è©±ï¼‰
      - ä¸»è¦ç›®æ¨™å—çœ¾
      - æ ¸å¿ƒåƒ¹å€¼ä¸»å¼µ

    docs/intent/non-negotiables.md:
      - æŠ€è¡“ç´„æŸï¼ˆå¦‚ï¼šå¿…é ˆæ”¯æ´é›¢ç·šã€è³‡æ–™å¿…é ˆå¯åŒ¯å‡ºï¼‰
      - ç”¢å“ç´„æŸï¼ˆå¦‚ï¼šå¿…é ˆæ”¯æ´å¤šèªè¨€ã€ä¸ä¾è³´å–®ä¸€ä¾›æ‡‰å•†ï¼‰
      - å®‰å…¨ç´„æŸï¼ˆå¦‚ï¼šä½¿ç”¨è€…è³‡æ–™ä¸é€å¾€ç¬¬ä¸‰æ–¹ï¼‰

    docs/intent/expansion-vector.md:
      - çŸ­æœŸæ“´å±•æ–¹å‘ï¼ˆæœ¬å­£ï¼‰
      - ä¸­æœŸæ“´å±•æ–¹å‘ï¼ˆæœ¬å¹´ï¼‰
      - æ˜ç¢ºæ’é™¤çš„æ–¹å‘ï¼ˆä¸åšçš„äº‹ï¼‰

# ------------------------------------------------------------
# è¦å‰‡å®šç¾©
# ------------------------------------------------------------
rules:

  - id: I1
    name: "å¼•å…¥å¹³å°é–å®šæ ¼å¼é ˆæä¾›é€ƒç”Ÿè‰™"
    description: |
      ç•¶è®Šæ›´å¼•å…¥ä¾›æ‡‰å•†ç‰¹å®šæ ¼å¼ã€å°ˆæœ‰ APIã€æˆ–å¹³å°é–å®šæŠ€è¡“æ™‚ï¼Œ
      å¿…é ˆåŒæ™‚æä¾›é€ƒç”Ÿè‰™ï¼ˆescape hatchï¼‰ï¼Œç¢ºä¿ç³»çµ±ä¸æœƒè¢«
      å–®ä¸€ä¾›æ‡‰å•†æˆ–æ ¼å¼æ°¸ä¹…ç¶å®šã€‚
    severity: error
    condition: |
      changes_introduce(vendor_specific_format OR proprietary_api OR platform_lock_in)
      AND NOT provides_escape_hatch
    action: block
    message: |
      âŒ åµæ¸¬åˆ°å¼•å…¥å¹³å°é–å®šæ ¼å¼ä½†æœªæä¾›é€ƒç”Ÿè‰™ã€‚

      åµæ¸¬åˆ°çš„é–å®šé¢¨éšªï¼š
      - é¡å‹ï¼š{lock_in_type}
      - æ¶‰åŠæª”æ¡ˆï¼š{affected_files}

      è«‹æä¾›ä»¥ä¸‹ä»»ä¸€é€ƒç”Ÿè‰™ï¼š
      1. æŠ½è±¡å±¤ï¼ˆAdapter/Interfaceï¼‰éš”é›¢ä¾›æ‡‰å•†ç‰¹å®šé‚è¼¯
      2. åŒ¯å‡ºå·¥å…·ï¼Œå¯å°‡è³‡æ–™è½‰æ›ç‚ºé–‹æ”¾æ ¼å¼
      3. æ›¿ä»£å¯¦ä½œæ–¹æ¡ˆï¼ˆå¯åˆ‡æ›çš„ providerï¼‰

      åƒè€ƒ docs/intent/non-negotiables.md ä¸­çš„ä¾›æ‡‰å•†é–å®šæ”¿ç­–ã€‚

  - id: I2
    name: "éš±æ€§è€¦åˆï¼ˆå¿…é ˆä¾è³´ç‰¹å®šå¹³å° runtimeï¼‰é ˆèªªæ˜èˆ‡æ›¿ä»£æ–¹æ¡ˆ"
    description: |
      ç•¶è®Šæ›´å¼•å…¥å°ç‰¹å®šå¹³å° runtime çš„éš±æ€§ä¾è³´
      ï¼ˆå¦‚ï¼šåªèƒ½åœ¨ç‰¹å®šé›²ç«¯ç’°å¢ƒåŸ·è¡Œã€ä¾è³´ç‰¹å®šç€è¦½å™¨ APIã€
      éœ€è¦ç‰¹å®šä½œæ¥­ç³»çµ±åŠŸèƒ½ï¼‰æ™‚ï¼Œå¿…é ˆæ˜ç¢ºèªªæ˜ä¸¦æä¾›æ›¿ä»£æ–¹æ¡ˆã€‚
    severity: error
    condition: |
      changes_introduce(platform_runtime_dependency)
      AND dependency_is_implicit
      AND NOT (
        commit_message CONTAINS "PLATFORM-DEP:"
        OR changed_files INTERSECT ["{{ADR_DIR}}/**"]
      )
    action: block
    message: |
      âŒ åµæ¸¬åˆ°éš±æ€§å¹³å° runtime è€¦åˆä½†ç¼ºå°‘èªªæ˜ã€‚

      åµæ¸¬åˆ°çš„éš±æ€§ä¾è³´ï¼š
      - Runtimeï¼š{platform_runtime}
      - å½±éŸ¿ç¯„åœï¼š{affected_scope}

      è«‹é¸æ“‡ä»¥ä¸‹å…¶ä¸€ï¼š
      1. åœ¨ commit message ä¸­åŠ å…¥ PLATFORM-DEP: æ¨™è¨˜ï¼Œèªªæ˜ï¼š
         - ç‚ºä½•éœ€è¦æ­¤å¹³å°ä¾è³´
         - åœ¨å…¶ä»–ç’°å¢ƒçš„æ›¿ä»£æ–¹æ¡ˆæˆ–é™ç´šç­–ç•¥
      2. å»ºç«‹ ADR è©³ç´°è¨˜éŒ„å¹³å°ä¾è³´æ±ºç­–

# ------------------------------------------------------------
# å°é–æ¢ä»¶ï¼ˆç¡¬æ€§é˜»æ“‹ï¼‰
# ------------------------------------------------------------
blocks:
  - id: I_BLOCK_1
    name: "ç¦æ­¢é•å non-negotiables ä¸”ç„¡è£œæ•‘æ–¹æ¡ˆ"
    description: |
      ä»»ä½•é•å docs/intent/non-negotiables.md ä¸­å®šç¾©çš„ä¸å¯å¦¥å”é …çš„è®Šæ›´ï¼Œ
      è‹¥æœªæä¾›è£œæ•‘æ–¹æ¡ˆï¼ˆremediation planï¼‰ï¼Œå°‡è¢«ç¡¬æ€§é˜»æ“‹ã€‚
    condition: |
      violates(intent_map.non_negotiables)
      AND NOT has_remediation_plan
      AND NOT commit_message CONTAINS "NON-NEG-EXEMPT:"
    action: block
    message: |
      ğŸš¨ å°é–ï¼šè®Šæ›´é•å non-negotiables ä¸”ç„¡è£œæ•‘æ–¹æ¡ˆã€‚

      é•åçš„é …ç›®ï¼š
      - {violated_non_negotiable}

      è«‹é¸æ“‡ä»¥ä¸‹å…¶ä¸€ï¼š
      1. ä¿®æ”¹å¯¦ä½œä»¥ç¬¦åˆ non-negotiables
      2. æä¾›è£œæ•‘æ–¹æ¡ˆï¼ˆåœ¨ PR æè¿°æˆ– ADR ä¸­èªªæ˜ï¼‰
      3. å¦‚ç¢ºèªéœ€è¦ä¾‹å¤–ï¼Œåœ¨ commit message ä¸­åŠ å…¥
         NON-NEG-EXEMPT: ä¸¦èªªæ˜ç†ç”±ï¼ˆéœ€ tech lead æ ¸å‡†ï¼‰

# ------------------------------------------------------------
# æ¼‚ç§»æŒ‡æ¨™
# ------------------------------------------------------------
drift_indicators:
  - name: "ä¾›æ‡‰å•† API ç›´æ¥å‘¼å«å¯†åº¦"
    description: "ç›´æ¥å‘¼å«ä¾›æ‡‰å•† APIï¼ˆéé€éæŠ½è±¡å±¤ï¼‰çš„æ¯”ä¾‹"
    threshold: "< 10% of total API calls"
    measurement: "vendor_direct_calls / total_api_calls"

  - name: "å¹³å°ç‰¹å®šç¨‹å¼ç¢¼æ¯”ä¾‹"
    description: "åªèƒ½åœ¨ç‰¹å®šå¹³å°åŸ·è¡Œçš„ç¨‹å¼ç¢¼ä½”æ¯”"
    threshold: "< 15% of source code"
    measurement: "platform_specific_lines / total_lines"

  - name: "è³‡æ–™æ ¼å¼å¯æ”œæ€§"
    description: "æ‰€æœ‰ä½¿ç”¨è€…è³‡æ–™å¿…é ˆå¯åŒ¯å‡ºç‚ºé–‹æ”¾æ ¼å¼"
    threshold: "100% exportable"
    measurement: "exportable_data_types / total_data_types"

  - name: "Non-negotiable åˆè¦ç‡"
    description: "ç¬¦åˆ non-negotiables çš„å…ƒä»¶æ¯”ä¾‹"
    threshold: ">= 100%"
    measurement: "compliant_components / total_components"

# ------------------------------------------------------------
# è±å…æ¢ä»¶
# ------------------------------------------------------------
exemptions:
  - description: "é–‹ç™¼ç’°å¢ƒç‰¹å®šè¨­å®šä¸è§¸ç™¼ï¼ˆå¦‚ dev server è¨­å®šï¼‰"
    condition: |
      file_path MATCH ["**/dev/**", "**/.dev.*", "**/development.*"]
      AND NOT affects_production_code
  - description: "å¯¦é©—æ€§åŠŸèƒ½ï¼ˆfeature flag æ§åˆ¶ï¼‰æš«æ™‚è±å…"
    condition: |
      behind_feature_flag
      AND feature_flag_documented
  - description: "é™„æœ‰ tech lead æ ¸å‡†çš„è±å…æ¨™è¨˜"
    condition: commit_message CONTAINS "NON-NEG-EXEMPT:"

# ------------------------------------------------------------
# è‡ªå‹•ä¿®æ­£å»ºè­°
# ------------------------------------------------------------
suggestions:
  - trigger: I1
    hint: |
      å»ºè­°æ­¥é©Ÿï¼š
      1. è­˜åˆ¥ä¾›æ‡‰å•†ç‰¹å®šçš„éƒ¨åˆ†ï¼ˆAPI callã€è³‡æ–™æ ¼å¼ã€SDKï¼‰
      2. å»ºç«‹æŠ½è±¡ä»‹é¢ï¼ˆInterface / Adapter patternï¼‰
      3. å°‡ä¾›æ‡‰å•†ç‰¹å®šé‚è¼¯å°è£åœ¨ adapter ä¸­
      4. æä¾›è‡³å°‘ä¸€å€‹æ›¿ä»£ adapterï¼ˆæˆ– mock adapterï¼‰
      5. åœ¨æ–‡ä»¶ä¸­è¨˜éŒ„å¦‚ä½•åˆ‡æ› provider

  - trigger: I2
    hint: |
      å»ºè­°æ­¥é©Ÿï¼š
      1. åˆ—å‡ºæ‰€æœ‰å¹³å°ç‰¹å®šçš„ API æˆ–åŠŸèƒ½ä½¿ç”¨
      2. è©•ä¼°åœ¨å…¶ä»–ç’°å¢ƒçš„å¯è¡Œæ›¿ä»£æ–¹æ¡ˆ
      3. å¯¦ä½œ graceful degradationï¼ˆå„ªé›…é™ç´šï¼‰
      4. åœ¨ ADR æˆ– commit message ä¸­è¨˜éŒ„æ±ºç­–

  - trigger: I_BLOCK_1
    hint: |
      å»ºè­°æ­¥é©Ÿï¼š
      1. é‡æ–°æª¢è¦– docs/intent/non-negotiables.md
      2. è©•ä¼°æ˜¯å¦æœ‰ç¬¦åˆ non-negotiables çš„æ›¿ä»£å¯¦ä½œ
      3. è‹¥ç¢ºå¯¦éœ€è¦ä¾‹å¤–ï¼š
         a. æ’°å¯«è£œæ•‘æ–¹æ¡ˆï¼ˆæ™‚é–“è¡¨ + å…·é«”æ­¥é©Ÿï¼‰
         b. å–å¾— tech lead æ ¸å‡†
         c. åœ¨ commit message ä¸­åŠ å…¥ NON-NEG-EXEMPT:
